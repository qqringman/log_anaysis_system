<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Â¢ûÂº∑Ê™îÊ°àÊ™¢Ë¶ñÂô® - {{ file_name }}</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Animate.css -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success-gradient: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            --danger-gradient: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            --warning-gradient: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            --line-highlight: rgba(255, 193, 7, 0.3);
            --line-target: rgba(220, 53, 69, 0.2);
            --search-highlight: rgba(255, 235, 59, 0.8);
            --bookmark-color: #28a745;
            --shadow-light: 0 4px 6px rgba(0,0,0,0.07);
            --shadow-medium: 0 8px 25px rgba(0,0,0,0.12);
            --shadow-heavy: 0 15px 35px rgba(0,0,0,0.1);
            --line-hover: rgba(52, 152, 219, 0.08);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            font-size: 14px;
            margin: 0;
            padding-bottom: 80px;
            position: relative;
            min-height: 100vh;
        }

        .file-header {
            background: var(--primary-gradient);
            color: white;
            padding: 1.5rem 0;
            box-shadow: var(--shadow-medium);
            position: relative;
            overflow: hidden;
        }

        .file-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
            opacity: 0.3;
        }

        .file-header .container-fluid {
            position: relative;
            z-index: 1;
        }

        /* Ê™îÊ°àË≥áË®äË®≠Ë®à */
        .file-info-badge {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 12px 24px;
            border-radius: 50px;
            display: inline-flex;
            align-items: center;
            gap: 20px;
            font-size: 0.9rem;
            margin-top: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .file-info-badge .info-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .file-info-badge .info-item i {
            font-size: 1rem;
            opacity: 0.8;
        }

        .file-info-badge .divider {
            width: 1px;
            height: 20px;
            background: rgba(255, 255, 255, 0.4);
        }

        .file-viewer {
            background: white;
            border-radius: 20px;
            box-shadow: var(--shadow-medium);
            overflow: hidden;
            margin-top: 1.5rem;
            position: relative;
            margin-bottom: 30px;
        }

        .toolbar {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 1rem;
            border-bottom: 2px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.75rem;
        }

        .toolbar-group {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        /* ÊêúÂ∞ãÊ°ÜË®≠Ë®à */
        .search-container {
            position: relative;
            min-width: 400px;
            max-width: 500px;
        }

        .search-input {
            padding: 10px 140px 10px 20px;
            border-radius: 50px;
            border: 2px solid #dee2e6;
            transition: all 0.3s ease;
            font-size: 0.95rem;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
        }

        .search-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
            background: white;
        }

        .search-controls {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .regex-toggle {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 20px;
            padding: 5px 12px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #6c757d;
        }

        .regex-toggle.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .search-info {
            background: white;
            padding: 4px 12px;
            border-radius: 20px;
            border: 1px solid #dee2e6;
            font-size: 0.8rem;
            color: #6c757d;
            font-weight: 500;
        }

        .btn-modern {
            border-radius: 25px;
            padding: 8px 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .btn-modern:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-light);
        }

        .btn-gradient-primary {
            background: var(--primary-gradient);
            color: white;
            border-color: transparent;
        }

        .btn-gradient-primary:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            color: white;
        }

        .btn-gradient-success {
            background: var(--success-gradient);
            color: white;
        }

        .btn-gradient-warning {
            background: var(--warning-gradient);
            color: white;
        }

        .line-container {
            max-height: 75vh;
            overflow-y: auto;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
            background: #fafafa;
            position: relative;
            scroll-behavior: smooth;
        }

        .code-line {
            display: flex;
            border-bottom: 1px solid #eee;
            transition: all 0.2s ease;
            position: relative;
            min-height: 22px;
        }

        /* ÊªëÈº†hoverÊïàÊûú */
        .code-line:hover {
            background: var(--line-hover);
            box-shadow: inset 3px 0 0 rgba(52, 152, 219, 0.4);
        }

        .line-number {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-right: 3px solid #dee2e6;
            padding: 6px 12px;
            text-align: right;
            min-width: 90px;
            color: #6c757d;
            font-weight: 600;
            user-select: none;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.3s ease;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: flex-end;
        }

        .line-number:hover {
            background: var(--primary-gradient);
            color: white;
            text-decoration: none;
            transform: scale(1.02);
        }

        .line-number.bookmark {
            background: var(--bookmark-color) !important;
            color: white !important;
            font-weight: bold;
            box-shadow: var(--shadow-light);
        }

        .line-number.bookmark::before {
            content: 'üìå';
            position: absolute;
            left: 4px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 10px;
        }

        .line-number.jump-point {
            background: var(--warning-gradient) !important;
            color: white !important;
            font-weight: bold;
        }

        .line-number.jump-point::after {
            content: 'üéØ';
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 10px;
        }

        .line-content {
            flex: 1;
            padding: 6px 15px;
            background: white;
            white-space: pre-wrap;
            word-break: break-all;
            overflow-wrap: break-word;
            position: relative;
        }

        .line-target {
            background: var(--line-target) !important;
            border-left: 4px solid #dc3545;
            animation: targetPulse 2s ease-in-out;
        }

        .line-target .line-number {
            background: var(--danger-gradient);
            color: white;
            font-weight: bold;
        }

        .line-target .line-content {
            background: var(--line-target);
            font-weight: 500;
        }

        @keyframes targetPulse {
            0%, 100% { background: var(--line-target); }
            50% { background: rgba(220, 53, 69, 0.4); }
        }

        .search-highlight {
            background: var(--search-highlight) !important;
            color: #000 !important;
            border-radius: 3px;
            padding: 1px 3px;
            font-weight: bold;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            animation: highlightGlow 1s ease-in-out;
        }

        .search-highlight.current {
            background: #ff5722 !important;
            color: white !important;
            animation: currentHighlight 1s ease-in-out infinite alternate;
        }

        @keyframes highlightGlow {
            0% { box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
            50% { box-shadow: 0 0 10px rgba(255, 235, 59, 0.8); }
            100% { box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        }

        @keyframes currentHighlight {
            0% { transform: scale(1); }
            100% { transform: scale(1.1); }
        }

        /* Âè≥ÈçµÈÅ∏ÂñÆhighlightÈ°èËâ≤ */
        .highlight-color-1 { background: rgba(255, 182, 193, 0.7) !important; border-left: 3px solid #e91e63; }
        .highlight-color-2 { background: rgba(144, 238, 144, 0.7) !important; border-left: 3px solid #4caf50; }
        .highlight-color-3 { background: rgba(173, 216, 230, 0.7) !important; border-left: 3px solid #2196f3; }
        .highlight-color-4 { background: rgba(255, 218, 185, 0.7) !important; border-left: 3px solid #ff9800; }
        .highlight-color-5 { background: rgba(221, 160, 221, 0.7) !important; border-left: 3px solid #9c27b0; }
        .highlight-color-6 { background: rgba(255, 255, 224, 0.7) !important; border-left: 3px solid #ffeb3b; }
        .highlight-color-7 { background: rgba(176, 224, 230, 0.7) !important; border-left: 3px solid #00bcd4; }
        .highlight-color-8 { background: rgba(255, 250, 205, 0.7) !important; border-left: 3px solid #cddc39; }
        .highlight-color-9 { background: rgba(152, 251, 152, 0.7) !important; border-left: 3px solid #8bc34a; }
        .highlight-color-10 { background: rgba(255, 160, 122, 0.7) !important; border-left: 3px solid #ff5722; }

        .status-bar {
            background: linear-gradient(135deg, #343a40 0%, #495057 100%);
            color: white;
            padding: 0.75rem 1rem;
            font-size: 0.85rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            bottom: 0;
            z-index: 100;
        }

        .status-item {
            margin-right: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-item i {
            color: #ffc107;
        }

        .context-menu {
            position: fixed;
            background: white;
            border: none;
            border-radius: 12px;
            box-shadow: var(--shadow-heavy);
            padding: 0.5rem 0;
            z-index: 10000;
            min-width: 220px;
            backdrop-filter: blur(10px);
            animation: contextMenuSlide 0.2s ease-out;
        }

        @keyframes contextMenuSlide {
            0% { opacity: 0; transform: translateY(-10px) scale(0.95); }
            100% { opacity: 1; transform: translateY(0) scale(1); }
        }

        .context-menu-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 500;
        }

        .context-menu-item:hover {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            color: #667eea;
        }

        .context-menu-item.disabled {
            color: #6c757d;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .context-menu-separator {
            height: 1px;
            background: linear-gradient(90deg, transparent, #dee2e6, transparent);
            margin: 0.5rem 0;
        }

        .color-preview {
            width: 16px;
            height: 16px;
            border-radius: 3px;
            border: 1px solid #dee2e6;
        }

        /* ÁØÑÂúçÈÅ∏ÊìáÂô®Ë®≠Ë®à */
        .range-selector {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border: 2px solid #667eea;
            border-radius: 20px;
            padding: 2rem;
            margin: 1rem;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.15);
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }

        .range-selector::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary-gradient);
        }

        .range-selector h6 {
            color: #667eea;
            font-weight: 600;
            margin-bottom: 1.5rem;
        }

        .range-selector .form-control {
            border-radius: 12px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .range-selector .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.1);
        }

        .loading-overlay {
            position: absolute;
            left: 0;
            right: 0;
            height: 80px;
            background: linear-gradient(to bottom, rgba(255,255,255,0.95), rgba(255,255,255,0.8));
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .loading-overlay.top {
            top: 0;
        }

        .loading-overlay.bottom {
            bottom: 0;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .compact-info {
            font-size: 0.85rem;
            color: rgba(255,255,255,0.9);
            margin-bottom: 0.5rem;
            background: rgba(255,255,255,0.1);
            padding: 0.5rem 1rem;
            border-radius: 25px;
            display: inline-block;
        }

        /* Ë∑≥ËΩâÊèêÁ§∫ */
        .jump-navigation {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 152, 0, 0.95);
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            box-shadow: 0 5px 20px rgba(255, 152, 0, 0.3);
            font-size: 0.9rem;
            z-index: 999;
            display: none;
            animation: slideInUp 0.3s ease-out;
            backdrop-filter: blur(10px);
        }

        @keyframes slideInUp {
            0% { transform: translate(-50%, 100%); opacity: 0; }
            100% { transform: translate(-50%, 0); opacity: 1; }
        }

        @keyframes slideOutDown {
            0% { transform: translate(-50%, 0); opacity: 1; }
            100% { transform: translate(-50%, 100%); opacity: 0; }
        }

        /* Âè≥‰∏ãËßíÊèêÁ§∫Ê®£Âºè */
        .toast-container {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 9999;
            display: flex;
            flex-direction: column-reverse;
            gap: 10px;
            max-width: 400px;
        }

        .custom-toast {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 16px 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            border: 1px solid rgba(255,255,255,0.3);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideInRight 0.3s ease-out;
            transition: all 0.3s ease;
        }

        @keyframes slideInRight {
            0% { transform: translateX(100%); opacity: 0; }
            100% { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOutRight {
            0% { transform: translateX(0); opacity: 1; }
            100% { transform: translateX(100%); opacity: 0; }
        }

        .custom-toast.hiding {
            animation: slideOutRight 0.3s ease-out;
        }

        .custom-toast .toast-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
        }

        .custom-toast.success .toast-icon {
            background: var(--success-gradient);
            color: white;
        }

        .custom-toast.info .toast-icon {
            background: var(--primary-gradient);
            color: white;
        }

        .custom-toast.warning .toast-icon {
            background: var(--warning-gradient);
            color: white;
        }

        .custom-toast.danger .toast-icon {
            background: var(--danger-gradient);
            color: white;
        }

        .custom-toast .toast-message {
            flex: 1;
            font-size: 0.95rem;
            color: #2d3748;
            font-weight: 500;
        }

        .custom-toast .toast-close {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: rgba(0,0,0,0.05);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .custom-toast .toast-close:hover {
            background: rgba(0,0,0,0.1);
            transform: scale(1.1);
        }

        /* ÂåØÂá∫ÊåâÈàïË®≠Ë®à */
        .btn-export {
            background: linear-gradient(135deg, #00d2ff 0%, #3a7bd5 100%);
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 50px;
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 5px 15px rgba(58, 123, 213, 0.3);
        }

        .btn-export:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(58, 123, 213, 0.4);
            color: white;
        }

        .btn-export i {
            font-size: 1.1rem;
        }

        .copyright-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            text-align: center;
            padding: 10px 0;
            font-size: 0.8rem;
            z-index: 100;
        }

        .copyright-footer i {
            color: #e74c3c;
            margin: 0 5px;
        }

        /* ÈüøÊáâÂºèË™øÊï¥ */
        @media (max-width: 768px) {
            .toolbar {
                flex-direction: column;
                align-items: stretch;
                gap: 1rem;
            }
            
            .toolbar-group {
                justify-content: center;
                flex-wrap: wrap;
            }
            
            .search-container {
                min-width: 100%;
            }
            
            .line-number {
                min-width: 60px;
                font-size: 12px;
            }
            
            .file-header {
                padding: 1rem 0;
            }
            
            .file-header .display-6 {
                font-size: 1.5rem;
            }
            
            .file-info-badge {
                flex-wrap: wrap;
                gap: 10px;
                font-size: 0.8rem;
            }
            
            .file-info-badge .divider {
                display: none;
            }
        }

        /* ÊªæÂãïÊ¢ùÁæéÂåñ */
        .line-container::-webkit-scrollbar {
            width: 12px;
        }

        .line-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 6px;
        }

        .line-container::-webkit-scrollbar-thumb {
            background: var(--primary-gradient);
            border-radius: 6px;
        }

        .line-container::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        }
    </style>
</head>
<body>
    <!-- Ê™îÊ°àÊ®ôÈ°åÂçÄÂüü -->
    <div class="file-header">
        <div class="container-fluid">
            <div class="row align-items-center">
                <div class="col-lg-8">
                    <h4 class="mb-2 animate__animated animate__fadeInLeft">
                        <i class="fas fa-file-code me-2"></i>{{ file_name }}
                    </h4>
                    <div class="file-info-badge animate__animated animate__fadeInLeft animate__delay-1s">
                        <div class="info-item">
                            <i class="fas fa-folder-open"></i>
                            <span>{{ file_path }}</span>
                        </div>
                        <div class="divider"></div>
                        <div class="info-item">
                            <i class="fas fa-list-ol"></i>
                            <span>{{ result.total_lines }} Ë°å</span>
                        </div>
                        <div class="divider"></div>
                        <div class="info-item">
                            <i class="fas fa-eye"></i>
                            <span>È°ØÁ§∫: {{ result.start_line }}-{{ result.end_line }}</span>
                        </div>
                        <div class="divider"></div>
                        <div class="info-item">
                            <i class="fas fa-crosshairs"></i>
                            <span>ÁõÆÊ®ô: Á¨¨ {{ result.target_line }} Ë°å</span>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4 text-end">
                    <div class="animate__animated animate__fadeInRight">
                        <button class="btn btn-outline-light btn-modern me-2" onclick="window.history.back()">
                            <i class="fas fa-arrow-left me-1"></i>ËøîÂõû
                        </button>
                        <button class="btn btn-export" onclick="exportFile()">
                            <i class="fas fa-cloud-download-alt"></i>
                            <span>ÂåØÂá∫Ê™îÊ°à</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid">
        <!-- Â∑•ÂÖ∑Âàó -->
        <div class="file-viewer">
            <div class="toolbar">
                <div class="toolbar-group">
                    <button class="btn btn-gradient-primary btn-modern" onclick="scrollToTarget()">
                        <i class="fas fa-crosshairs me-1"></i>ÁõÆÊ®ôË°å
                    </button>
                    <button class="btn btn-outline-info btn-modern" onclick="showRangeSelector()">
                        <i class="fas fa-edit me-1"></i>ÈÅ∏ÊìáÁØÑÂúç
                    </button>
                    <button class="btn btn-outline-warning btn-modern" onclick="clearAllHighlights()">
                        <i class="fas fa-eraser me-1"></i>Ê∏ÖÈô§È´ò‰∫Æ
                    </button>
                    <button class="btn btn-outline-secondary btn-modern" onclick="toggleJumpMode()" id="jump-mode-btn">
                        <i class="fas fa-crosshairs me-1"></i>Ë∑≥ËΩâÊ®°Âºè
                    </button>
                </div>
                
                <div class="toolbar-group">
                    <div class="search-container">
                        <input type="text" class="form-control search-input" 
                               id="search-input" placeholder="ÊêúÂ∞ãÊñáÂ≠ó (ÊîØÊè¥Ê≠£Ë¶èË°®ÈÅîÂºè)">
                        <div class="search-controls">
                            <button class="regex-toggle" id="regex-toggle" onclick="toggleRegex()">
                                <i class="fas fa-code"></i> Regex
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="findPrevious()" title="‰∏ä‰∏ÄÂÄã">
                                <i class="fas fa-chevron-up"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="findNext()" title="‰∏ã‰∏ÄÂÄã">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                            <div class="search-info" id="search-info">0 / 0</div>
                        </div>
                    </div>
                </div>
                
                <div class="toolbar-group">
                    <div class="input-group" style="width: 200px;">
                        <input type="number" class="form-control" id="jump-line" 
                               placeholder="Ë∑≥ËΩâË°åËôü" min="1" max="{{ result.total_lines }}">
                        <button class="btn btn-gradient-primary" onclick="jumpToLine()">
                            <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- ÁØÑÂúçÈÅ∏ÊìáÂô® -->
            <div id="range-selector" class="range-selector" style="display: none;">
                <h6><i class="fas fa-sliders-h me-2"></i>ÈÅ∏ÊìáÈ°ØÁ§∫ÁØÑÂúç</h6>
                <div class="row">
                    <div class="col-md-3">
                        <label class="form-label">Ëµ∑ÂßãË°å</label>
                        <input type="number" class="form-control" id="range-start" 
                               min="1" max="{{ result.total_lines }}" value="{{ result.start_line }}">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">ÁµêÊùüË°å</label>
                        <input type="number" class="form-control" id="range-end" 
                               min="1" max="{{ result.total_lines }}" value="{{ result.end_line }}">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">‰∏ä‰∏ãÊñáË°åÊï∏</label>
                        <input type="number" class="form-control" id="range-context" 
                               min="0" max="500" value="200">
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button class="btn btn-gradient-primary me-2" onclick="applyRange()">
                            <i class="fas fa-check me-1"></i>Â•óÁî®
                        </button>
                        <button class="btn btn-outline-secondary" onclick="closeRangeSelector()">
                            <i class="fas fa-times me-1"></i>ÂèñÊ∂à
                        </button>
                    </div>
                </div>
            </div>

            <!-- Á®ãÂºèÁ¢ºÂÖßÂÆπ -->
            <div class="line-container" id="line-container">
                <div id="loading-overlay-top" class="loading-overlay top" style="display: none;">
                    <div class="loading-spinner"></div>
                </div>
                <div id="loading-overlay-bottom" class="loading-overlay bottom" style="display: none;">
                    <div class="loading-spinner"></div>
                </div>
                {% for line in result.lines %}
                <div class="code-line {% if line.is_target %}line-target{% endif %}" 
                     id="line-{{ line.line_number }}" data-line="{{ line.line_number }}">
                    <div class="line-number" 
                         onclick="handleLineClick({{ line.line_number }})"
                         ondblclick="handleLineDoubleClick({{ line.line_number }})"
                         oncontextmenu="showLineContextMenu(event, {{ line.line_number }})"
                         title="ÈªûÊìäË®≠ÂÆöÊõ∏Á±§/Ë∑≥ËΩâÈªûÔºåÈõôÊìäÈ°ØÁ§∫‰∏ä‰∏ãÊñáÔºåÂè≥ÈçµÊõ¥Â§öÈÅ∏È†Ö">
                        {{ line.line_number }}
                    </div>
                    <div class="line-content" oncontextmenu="showContentContextMenu(event, {{ line.line_number }})">{{ line.content if line.content else ' ' }}</div>
                </div>
                {% endfor %}
            </div>

            <!-- ÁãÄÊÖãÂàó -->
            <div class="status-bar">
                <div class="d-flex align-items-center">
                    <div class="status-item">
                        <i class="fas fa-map-marker-alt"></i>
                        <span id="status-line">Á¨¨ {{ result.target_line }} Ë°å</span>
                    </div>
                    <div class="status-item">
                        <i class="fas fa-bookmark"></i>
                        <span id="status-bookmarks">Êõ∏Á±§: 0</span>
                    </div>
                    <div class="status-item">
                        <i class="fas fa-search"></i>
                        <span id="status-search">ÊêúÂ∞ã: ÁÑ°</span>
                    </div>
                    <div class="status-item">
                        <i class="fas fa-crosshairs"></i>
                        <span id="status-jumps">Ë∑≥ËΩâÈªû: 0</span>
                    </div>
                </div>
                <div class="d-flex align-items-center">
                    <div class="status-item">
                        <i class="fas fa-info-circle"></i>
                        <span id="status-position">{{ result.start_line }}-{{ result.end_line }} / {{ result.total_lines }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ë∑≥ËΩâÂ∞éËà™ -->
    <div id="jump-navigation" class="jump-navigation">
        <i class="fas fa-crosshairs me-2"></i>
        Ë∑≥ËΩâÊ®°ÂºèÂ∑≤ÂïüÁî® - F2: ‰∏ã‰∏ÄÂÄã | Shift+F2: ‰∏ä‰∏ÄÂÄã
    </div>

    <!-- Âè≥ÈçµÈÅ∏ÂñÆ -->
    <div id="context-menu" class="context-menu" style="display: none;"></div>

    <!-- Toast ÂÆπÂô® -->
    <div class="toast-container" id="toast-container"></div>

    <!-- ÁâàÊ¨äËÅ≤Êòé -->
    <div class="copyright-footer">
        <i class="fas fa-heart"></i>
        ¬© 2025 Vince. All rights reserved.
        <i class="fas fa-code"></i>
        Enhanced File Viewer v5
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // ÂÖ®ÂüüËÆäÊï∏
        let bookmarks = new Set();
        let jumpPoints = new Set();
        let currentJumpIndex = 0;
        let searchResults = [];
        let currentSearchIndex = 0;
        let highlightColors = {};
        let colorIndex = 1;
        let selectedText = '';
        let isLoadingMore = false;
        let jumpModeEnabled = false;
        let lastSearchText = '';
        let useRegex = false;
        let currentStartLine = {{ result.start_line }};
        let currentEndLine = {{ result.end_line }};
        let totalLines = {{ result.total_lines }};
        
        // È†ÅÈù¢ÂàùÂßãÂåñ
        $(document).ready(function() {
            setupKeyboardShortcuts();
            setupScrollHandler();
            scrollToTarget();
            updateStatus();
            
            // ÂàùÂßãÂåñÂ∑•ÂÖ∑ÊèêÁ§∫
            initializeTooltips();
        });

        function initializeTooltips() {
            // ÁÇ∫Â∑•ÂÖ∑ÂàóÊåâÈàïÊ∑ªÂä†Â∑•ÂÖ∑ÊèêÁ§∫
            $('[title]').each(function() {
                $(this).attr('data-bs-toggle', 'tooltip');
            });
            
            // ÂàùÂßãÂåñ Bootstrap Â∑•ÂÖ∑ÊèêÁ§∫
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function(tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        }

        // ÈçµÁõ§Âø´Êç∑Èçµ
        function setupKeyboardShortcuts() {
            $(document).keydown(function(e) {
                // Ctrl+F ÊêúÂ∞ã
                if (e.ctrlKey && e.which === 70) {
                    e.preventDefault();
                    $('#search-input').focus().select();
                }
                
                // F2 Ë∑≥ËΩâÂäüËÉΩ
                if (e.which === 113) { // F2
                    e.preventDefault();
                    if (e.shiftKey) {
                        gotoPreviousJump();
                    } else {
                        gotoNextJump();
                    }
                }
                
                // F3 Êõ∏Á±§Ë∑≥ËΩâ
                if (e.which === 114) { // F3
                    e.preventDefault();
                    if (e.shiftKey) {
                        gotoPreviousBookmark();
                    } else {
                        gotoNextBookmark();
                    }
                }
                
                // ESC Ê∏ÖÈô§ÊêúÂ∞ãÊàñÈóúÈñâÈÅ∏ÂñÆ
                if (e.which === 27) {
                    if ($('#search-input').is(':focus')) {
                        clearSearch();
                    }
                    hideContextMenu();
                    if (jumpModeEnabled) {
                        toggleJumpMode();
                    }
                }
                
                // Ctrl+G Ë∑≥ËΩâË°åËôü
                if (e.ctrlKey && e.which === 71) {
                    e.preventDefault();
                    $('#jump-line').focus().select();
                }
                
                // Enter Âú®ÊêúÂ∞ãÊ°Ü‰∏≠
                if (e.which === 13 && $('#search-input').is(':focus')) {
                    e.preventDefault();
                    if (e.shiftKey) {
                        findPrevious();
                    } else {
                        findNext();
                    }
                }
            });
            
            // ÊêúÂ∞ãËº∏ÂÖ•Ê°Ü‰∫ã‰ª∂
            $('#search-input').on('input', debounce(performSearch, 300));
        }

        // Èò≤ÊäñÂáΩÊï∏
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // ÊªæÂãïËôïÁêÜ - Ëá™ÂãïËºâÂÖ•Êõ¥Â§öÂÖßÂÆπ
        function setupScrollHandler() {
            const container = $('#line-container');
            container.on('scroll', debounce(function() {
                if (isLoadingMore) return;
                
                const scrollTop = container.scrollTop();
                const scrollHeight = container[0].scrollHeight;
                const clientHeight = container.height();
                
                // Êé•ËøëÈ†ÇÈÉ®ÊôÇËºâÂÖ•ÂâçÈù¢ÁöÑÂÖßÂÆπ
                if (scrollTop < 100 && currentStartLine > 1) {
                    loadMoreContent('before');
                }
                
                // Êé•ËøëÂ∫ïÈÉ®ÊôÇËºâÂÖ•ÂæåÈù¢ÁöÑÂÖßÂÆπ
                if (scrollTop + clientHeight > scrollHeight - 100 && currentEndLine < totalLines) {
                    loadMoreContent('after');
                }
                
                // Êõ¥Êñ∞Áï∂ÂâçË°åÁãÄÊÖã
                updateCurrentLineStatus();
            }, 100));
        }

        // ËºâÂÖ•Êõ¥Â§öÂÖßÂÆπ
        function loadMoreContent(direction) {
            if (isLoadingMore) return;
            isLoadingMore = true;
            
            const loadingOverlay = direction === 'before' ? $('#loading-overlay-top') : $('#loading-overlay-bottom');
            loadingOverlay.show();
            
            let newStart, newEnd;
            
            if (direction === 'before') {
                newStart = Math.max(1, currentStartLine - 200);
                newEnd = currentStartLine - 1;
            } else {
                newStart = currentEndLine + 1;
                newEnd = Math.min(totalLines, currentEndLine + 200);
            }
            
            $.get('/file_viewer', {
                path: '{{ file_path }}',
                line: direction === 'before' ? newStart : newEnd,
                context: 100,
                start: newStart,
                end: newEnd
            }).done(function(data) {
                // Ëß£ÊûêËøîÂõûÁöÑHTML‰∏¶ÊèêÂèñÊñ∞Ë°å
                const parser = new DOMParser();
                const doc = parser.parseFromString(data, 'text/html');
                const newLines = doc.querySelectorAll('.code-line');
                
                const container = $('#line-container');
                const scrollBefore = container[0].scrollHeight;
                const scrollTop = container.scrollTop();
                
                if (direction === 'before') {
                    // Âú®ÂâçÈù¢ÊèíÂÖ•
                    const firstLine = container.find('.code-line').first();
                    newLines.forEach(line => {
                        const newElement = $(line.outerHTML);
                        firstLine.before(newElement);
                        
                        // ÈáçÊñ∞Á∂ÅÂÆö‰∫ã‰ª∂
                        bindLineEvents(newElement);
                    });
                    
                    // ‰øùÊåÅÊªæÂãï‰ΩçÁΩÆ
                    const scrollAfter = container[0].scrollHeight;
                    container.scrollTop(scrollTop + (scrollAfter - scrollBefore));
                    
                    currentStartLine = newStart;
                } else {
                    // Âú®ÂæåÈù¢Ê∑ªÂä†
                    newLines.forEach(line => {
                        const newElement = $(line.outerHTML);
                        container.append(newElement);
                        
                        // ÈáçÊñ∞Á∂ÅÂÆö‰∫ã‰ª∂
                        bindLineEvents(newElement);
                    });
                    
                    currentEndLine = newEnd;
                }
                
                updateStatus();
                
                // ÈáçÊñ∞ÊáâÁî®ÊêúÂ∞ãÈ´ò‰∫Æ
                if (lastSearchText) {
                    performSearch();
                }
                
                // ÈáçÊñ∞ÊáâÁî®È°èËâ≤È´ò‰∫Æ
                reapplyHighlights();
                
            }).always(function() {
                loadingOverlay.fadeOut(300);
                isLoadingMore = false;
            });
        }

        // Á∂ÅÂÆöË°å‰∫ã‰ª∂
        function bindLineEvents(lineElement) {
            const lineNumber = lineElement.data('line');
            
            lineElement.find('.line-number')
                .on('click', function() {
                    handleLineClick(lineNumber);
                })
                .on('dblclick', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    handleLineDoubleClick(lineNumber);
                })
                .on('contextmenu', function(e) {
                    showLineContextMenu(e, lineNumber);
                });
            
            lineElement.find('.line-content').on('contextmenu', function(e) {
                showContentContextMenu(e, lineNumber);
            });
        }

        // ËôïÁêÜË°åÈªûÊìä
        function handleLineClick(lineNumber) {
            if (jumpModeEnabled) {
                toggleJumpPoint(lineNumber);
            } else {
                toggleBookmark(lineNumber);
            }
        }

        // ËôïÁêÜË°åÈõôÊìä
        function handleLineDoubleClick(lineNumber) {
            showToast('info', `Ê≠£Âú®ËºâÂÖ•Á¨¨ ${lineNumber} Ë°åÁöÑ‰∏ä‰∏ãÊñá...`);
            
            const url = new URL(window.location);
            url.searchParams.set('line', lineNumber);
            url.searchParams.set('start', Math.max(1, lineNumber - 200));
            url.searchParams.set('end', Math.min(totalLines, lineNumber + 200));
            url.searchParams.set('context', 200);
            window.location.href = url.toString();
        }

        // Ë∑≥ËΩâÊ®°ÂºèÂàáÊèõ
        function toggleJumpMode() {
            jumpModeEnabled = !jumpModeEnabled;
            const btn = $('#jump-mode-btn');
            const navigation = $('#jump-navigation');
            
            if (jumpModeEnabled) {
                btn.removeClass('btn-outline-secondary').addClass('btn-gradient-warning');
                btn.html('<i class="fas fa-crosshairs me-1"></i>ÈÄÄÂá∫Ë∑≥ËΩâ');
                navigation.show();
                
                // 1ÁßíÂæåËá™ÂãïÈö±ËóèÊèêÁ§∫
                setTimeout(() => {
                    navigation.addClass('animate__animated');
                    navigation.css('animation', 'slideOutDown 0.3s ease-out');
                    setTimeout(() => {
                        navigation.hide();
                        navigation.css('animation', '');
                    }, 300);
                }, 1000);
                
                showToast('info', 'Ë∑≥ËΩâÊ®°ÂºèÂ∑≤ÂïüÁî®');
            } else {
                btn.removeClass('btn-gradient-warning').addClass('btn-outline-secondary');
                btn.html('<i class="fas fa-crosshairs me-1"></i>Ë∑≥ËΩâÊ®°Âºè');
                navigation.hide();
                showToast('info', 'Ë∑≥ËΩâÊ®°ÂºèÂ∑≤ÈóúÈñâ');
            }
        }

        // ÂàáÊèõË∑≥ËΩâÈªû
        function toggleJumpPoint(lineNumber) {
            const lineElement = $(`#line-${lineNumber} .line-number`);
            
            if (jumpPoints.has(lineNumber)) {
                jumpPoints.delete(lineNumber);
                lineElement.removeClass('jump-point');
            } else {
                jumpPoints.add(lineNumber);
                lineElement.addClass('jump-point');
            }
            
            updateJumpStatus();
        }

        // ‰∏ã‰∏ÄÂÄãË∑≥ËΩâÈªû
        function gotoNextJump() {
            if (jumpPoints.size === 0) {
                showToast('warning', 'Ê≤íÊúâË®≠ÂÆöË∑≥ËΩâÈªûÔºåË´ãÂÖàË®≠ÂÆöË∑≥ËΩâÈªû');
                return;
            }
            
            const sortedJumps = Array.from(jumpPoints).sort((a, b) => a - b);
            const currentLine = getCurrentLine();
            
            let nextJump = sortedJumps.find(line => line > currentLine);
            if (!nextJump) {
                nextJump = sortedJumps[0]; // Âæ™Áí∞Âà∞Á¨¨‰∏ÄÂÄã
            }
            
            scrollToLine(nextJump);
            updateJumpStatus();
            showToast('success', `Ë∑≥ËΩâÂà∞Á¨¨ ${nextJump} Ë°å`);
        }

        // ‰∏ä‰∏ÄÂÄãË∑≥ËΩâÈªû
        function gotoPreviousJump() {
            if (jumpPoints.size === 0) {
                showToast('warning', 'Ê≤íÊúâË®≠ÂÆöË∑≥ËΩâÈªûÔºåË´ãÂÖàË®≠ÂÆöË∑≥ËΩâÈªû');
                return;
            }
            
            const sortedJumps = Array.from(jumpPoints).sort((a, b) => b - a);
            const currentLine = getCurrentLine();
            
            let prevJump = sortedJumps.find(line => line < currentLine);
            if (!prevJump) {
                prevJump = sortedJumps[0]; // Âæ™Áí∞Âà∞ÊúÄÂæå‰∏ÄÂÄã
            }
            
            scrollToLine(prevJump);
            updateJumpStatus();
            showToast('success', `Ë∑≥ËΩâÂà∞Á¨¨ ${prevJump} Ë°å`);
        }

        // ÂàáÊèõÊ≠£Ë¶èË°®ÈÅîÂºè
        function toggleRegex() {
            useRegex = !useRegex;
            const btn = $('#regex-toggle');
            
            if (useRegex) {
                btn.addClass('active');
                showToast('info', 'Â∑≤ÂïüÁî®Ê≠£Ë¶èË°®ÈÅîÂºèÊêúÂ∞ã');
            } else {
                btn.removeClass('active');
                showToast('info', 'Â∑≤ÈóúÈñâÊ≠£Ë¶èË°®ÈÅîÂºèÊêúÂ∞ã');
            }
            
            // ÈáçÊñ∞Âü∑Ë°åÊêúÂ∞ã
            if ($('#search-input').val()) {
                performSearch();
            }
        }

        // ÊêúÂ∞ãÂäüËÉΩ
        function performSearch() {
            const searchText = $('#search-input').val().trim();
            lastSearchText = searchText;
            clearSearchHighlights();
            
            if (!searchText) {
                updateSearchStatus('ÊêúÂ∞ã: ÁÑ°');
                return;
            }
            
            searchResults = [];
            let regex;
            
            try {
                if (useRegex) {
                    regex = new RegExp(searchText, 'gi');
                } else {
                    // ËΩâÁæ©ÁâπÊÆäÂ≠óÁ¨¶
                    const escapedText = searchText.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                    regex = new RegExp(escapedText, 'gi');
                }
            } catch (e) {
                showToast('danger', 'ÁÑ°ÊïàÁöÑÊ≠£Ë¶èË°®ÈÅîÂºè');
                return;
            }
            
            $('.line-content').each(function(index) {
                const content = $(this).text();
                const lineNumber = parseInt($(this).parent().data('line'));
                let newContent = content;
                let hasMatch = false;
                
                // ÊõøÊèõÂåπÈÖçÁöÑÊñáÂ≠ó
                newContent = content.replace(regex, function(match) {
                    hasMatch = true;
                    searchResults.push({
                        line: lineNumber,
                        element: this,
                        text: match
                    });
                    return '<span class="search-highlight">' + match + '</span>';
                });
                
                if (hasMatch) {
                    $(this).html(newContent);
                }
            });
            
            currentSearchIndex = 0;
            updateSearchStatus(`ÊâæÂà∞ ${searchResults.length} ÂÄãÁµêÊûú`);
            $('#search-info').text(`${searchResults.length > 0 ? currentSearchIndex + 1 : 0} / ${searchResults.length}`);
            
            if (searchResults.length > 0) {
                highlightCurrentResult();
            }
        }

        function clearSearchHighlights() {
            $('.search-highlight').each(function() {
                const parent = $(this).parent();
                const text = parent.text();
                parent.text(text);
            });
        }

        function highlightCurrentResult() {
            $('.search-highlight').removeClass('current');
            if (searchResults.length > 0 && currentSearchIndex < searchResults.length) {
                const result = searchResults[currentSearchIndex];
                
                // ÊâæÂà∞Â∞çÊáâÁöÑÈ´ò‰∫ÆÂÖÉÁ¥†
                const lineElement = $(`#line-${result.line}`);
                const highlights = lineElement.find('.search-highlight');
                
                if (highlights.length > 0) {
                    highlights.eq(0).addClass('current');
                    scrollToElement(lineElement);
                }
                
                updateSearchStatus(`${currentSearchIndex + 1} / ${searchResults.length}`);
                $('#search-info').text(`${currentSearchIndex + 1} / ${searchResults.length}`);
            }
        }

        function findNext() {
            if (searchResults.length === 0) return;
            currentSearchIndex = (currentSearchIndex + 1) % searchResults.length;
            highlightCurrentResult();
        }

        function findPrevious() {
            if (searchResults.length === 0) return;
            currentSearchIndex = currentSearchIndex > 0 ? currentSearchIndex - 1 : searchResults.length - 1;
            highlightCurrentResult();
        }

        function clearSearch() {
            $('#search-input').val('');
            clearSearchHighlights();
            searchResults = [];
            currentSearchIndex = 0;
            lastSearchText = '';
            updateSearchStatus('ÊêúÂ∞ã: ÁÑ°');
            $('#search-info').text('0 / 0');
        }

        // Êõ∏Á±§ÂäüËÉΩ
        function toggleBookmark(lineNumber) {
            const lineElement = $(`#line-${lineNumber} .line-number`);
            
            if (bookmarks.has(lineNumber)) {
                bookmarks.delete(lineNumber);
                lineElement.removeClass('bookmark');
                showToast('info', `Â∑≤ÁßªÈô§Á¨¨ ${lineNumber} Ë°åÁöÑÊõ∏Á±§`);
            } else {
                bookmarks.add(lineNumber);
                lineElement.addClass('bookmark');
                showToast('success', `Â∑≤Ë®≠ÂÆöÁ¨¨ ${lineNumber} Ë°åÁÇ∫Êõ∏Á±§`);
            }
            
            updateBookmarkStatus();
        }

        function gotoNextBookmark() {
            if (bookmarks.size === 0) {
                showToast('warning', 'Ê≤íÊúâË®≠ÂÆöÊõ∏Á±§');
                return;
            }
            
            const sortedBookmarks = Array.from(bookmarks).sort((a, b) => a - b);
            const currentLine = getCurrentLine();
            
            let nextBookmark = sortedBookmarks.find(line => line > currentLine);
            if (!nextBookmark) {
                nextBookmark = sortedBookmarks[0]; // Âæ™Áí∞Âà∞Á¨¨‰∏ÄÂÄã
            }
            
            scrollToLine(nextBookmark);
            updateStatus();
            showToast('success', `Ë∑≥ËΩâÂà∞Êõ∏Á±§ÔºöÁ¨¨ ${nextBookmark} Ë°å`);
        }

        function gotoPreviousBookmark() {
            if (bookmarks.size === 0) {
                showToast('warning', 'Ê≤íÊúâË®≠ÂÆöÊõ∏Á±§');
                return;
            }
            
            const sortedBookmarks = Array.from(bookmarks).sort((a, b) => b - a);
            const currentLine = getCurrentLine();
            
            let prevBookmark = sortedBookmarks.find(line => line < currentLine);
            if (!prevBookmark) {
                prevBookmark = sortedBookmarks[0]; // Âæ™Áí∞Âà∞ÊúÄÂæå‰∏ÄÂÄã
            }
            
            scrollToLine(prevBookmark);
            updateStatus();
            showToast('success', `Ë∑≥ËΩâÂà∞Êõ∏Á±§ÔºöÁ¨¨ ${prevBookmark} Ë°å`);
        }

        // Âè≥ÈçµÈÅ∏ÂñÆ
        function showLineContextMenu(event, lineNumber) {
            event.preventDefault();
            selectedText = '';
            showContextMenu(event, 'line', lineNumber);
        }

        function showContentContextMenu(event, lineNumber) {
            event.preventDefault();
            selectedText = window.getSelection().toString().trim();
            showContextMenu(event, 'content', lineNumber);
        }

        function showContextMenu(event, type, lineNumber = null) {
            const menu = $('#context-menu');
            let menuItems = [];
            
            if (type === 'line') {
                const isBookmarked = bookmarks.has(lineNumber);
                const isJumpPoint = jumpPoints.has(lineNumber);
                
                menuItems = [
                    { icon: 'bookmark', text: isBookmarked ? 'ÁßªÈô§Êõ∏Á±§' : 'Ë®≠ÂÆöÊõ∏Á±§', action: () => toggleBookmark(lineNumber) },
                    { icon: 'crosshairs', text: isJumpPoint ? 'ÁßªÈô§Ë∑≥ËΩâÈªû' : 'Ë®≠ÂÆöË∑≥ËΩâÈªû', action: () => toggleJumpPoint(lineNumber) },
                    { separator: true },
                    { icon: 'copy', text: 'Ë§áË£ΩË°åËôü', action: () => copyToClipboard(lineNumber.toString()) },
                    { icon: 'link', text: 'Ë§áË£ΩÈÄ£Áµê', action: () => copyLineLink(lineNumber) },
                    { icon: 'external-link-alt', text: 'Âú®Êñ∞È†ÅÈù¢ÊâìÈñã', action: () => openInNewPage(lineNumber) }
                ];
            } else {
                menuItems = [
                    { icon: 'copy', text: 'Ë§áË£Ω', action: () => copySelectedText(), disabled: !selectedText },
                    { separator: true },
                    { icon: 'highlighter', text: 'Êô∫ËÉΩÈ´ò‰∫Æ', action: () => highlightSelected(), disabled: !selectedText },
                    { separator: true }
                ];
                
                // Ê∑ªÂä†È°èËâ≤ÈÅ∏È†Ö
                const colors = [
                    { name: 'Á≤âÁ¥Ö', value: 1 },
                    { name: 'Á∂†Ëâ≤', value: 2 },
                    { name: 'ËóçËâ≤', value: 3 },
                    { name: 'Ê©ôËâ≤', value: 4 },
                    { name: 'Á¥´Ëâ≤', value: 5 },
                    { name: 'ÈªÉËâ≤', value: 6 },
                    { name: 'ÈùíËâ≤', value: 7 },
                    { name: 'Ê™∏Ê™¨', value: 8 },
                    { name: 'ËçâÁ∂†', value: 9 },
                    { name: 'Á¥ÖÊ©ô', value: 10 }
                ];
                
                colors.forEach(color => {
                    menuItems.push({
                        icon: 'circle',
                        text: `${color.name}È´ò‰∫Æ`,
                        color: color.value,
                        action: () => highlightWithColor(selectedText, color.value),
                        disabled: !selectedText
                    });
                });
                
                menuItems.push({ separator: true });
                menuItems.push({ icon: 'eraser', text: 'Ê∏ÖÈô§ÊâÄÊúâÈ´ò‰∫Æ', action: clearAllHighlights });
            }
            
            // ÁîüÊàêÈÅ∏ÂñÆHTML
            let menuHtml = '';
            menuItems.forEach(item => {
                if (item.separator) {
                    menuHtml += '<div class="context-menu-separator"></div>';
                } else {
                    const disabledClass = item.disabled ? 'disabled' : '';
                    const colorPreview = item.color ? 
                        `<div class="color-preview highlight-color-${item.color}"></div>` : 
                        `<i class="fas fa-${item.icon}"></i>`;
                    
                    menuHtml += `
                        <div class="context-menu-item ${disabledClass}" data-index="${menuItems.indexOf(item)}">
                            ${colorPreview}
                            <span>${item.text}</span>
                        </div>
                    `;
                }
            });
            
            menu.html(menuHtml);
            
            // Á∂ÅÂÆöÈªûÊìä‰∫ã‰ª∂
            menu.find('.context-menu-item').on('click', function() {
                if ($(this).hasClass('disabled')) return;
                
                const index = $(this).data('index');
                const item = menuItems[index];
                if (item && item.action) {
                    item.action();
                }
                hideContextMenu();
            });
            
            // Ë®àÁÆó‰ΩçÁΩÆ
            const menuWidth = 220;
            const menuHeight = menuItems.length * 40;
            const windowWidth = $(window).width();
            const windowHeight = $(window).height();
            
            let left = event.pageX;
            let top = event.pageY;
            
            if (left + menuWidth > windowWidth) {
                left = windowWidth - menuWidth - 10;
            }
            
            if (top + menuHeight > windowHeight) {
                top = windowHeight - menuHeight - 10;
            }
            
            menu.css({
                display: 'block',
                left: left + 'px',
                top: top + 'px'
            });
            
            // ÈªûÊìäÂÖ∂‰ªñÂú∞ÊñπÈóúÈñâÈÅ∏ÂñÆ
            $(document).one('click', hideContextMenu);
        }

        function hideContextMenu() {
            $('#context-menu').hide();
        }

        // È´ò‰∫ÆÂäüËÉΩ
        function highlightSelected() {
            if (!selectedText) return;
            highlightWithColor(selectedText, colorIndex);
            colorIndex = (colorIndex % 10) + 1;
        }

        function highlightWithColor(text, color) {
            if (!text) return;
            
            // ÂÑ≤Â≠òÈ´ò‰∫ÆË≥áË®ä
            if (!highlightColors[text]) {
                highlightColors[text] = [];
            }
            highlightColors[text].push(color);
            
            const escapedText = text.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const regex = new RegExp(`(${escapedText})`, 'gi');
            
            $('.line-content').each(function() {
                const $this = $(this);
                let html = $this.html();
                
                // Êö´ÊôÇÁßªÈô§ÁèæÊúâÁöÑÈ´ò‰∫ÆÊ®ôÁ±§
                const tempMarkers = [];
                html = html.replace(/<span class="[^"]*"[^>]*>(.*?)<\/span>/gi, function(match, content, offset) {
                    const marker = `__MARKER_${tempMarkers.length}__`;
                    tempMarkers.push({ marker, content, match });
                    return marker + content + marker;
                });
                
                // ÊáâÁî®Êñ∞ÁöÑÈ´ò‰∫Æ
                html = html.replace(regex, function(match) {
                    // Ê™¢Êü•ÊòØÂê¶Â∑≤Á∂ìÂú®Ê®ôË®ò‰∏≠
                    for (let temp of tempMarkers) {
                        if (html.indexOf(temp.marker + match + temp.marker) !== -1) {
                            return match;
                        }
                    }
                    return `<span class="highlight-color-${color}">${match}</span>`;
                });
                
                // ÈÇÑÂéüÂÖ∂‰ªñÈ´ò‰∫ÆÊ®ôÁ±§
                tempMarkers.forEach(temp => {
                    const markerRegex = new RegExp(temp.marker + '(.*?)' + temp.marker, 'g');
                    html = html.replace(markerRegex, temp.match);
                });
                
                $this.html(html);
            });
            
            showToast('success', `Â∑≤Áî®È°èËâ≤ ${color} È´ò‰∫ÆÊñáÂ≠ó: ${text}`);
        }

        function clearAllHighlights() {
            for (let i = 1; i <= 10; i++) {
                $(`.highlight-color-${i}`).each(function() {
                    const $this = $(this);
                    const text = $this.text();
                    $this.replaceWith(text);
                });
            }
            highlightColors = {};
            showToast('info', 'Â∑≤Ê∏ÖÈô§ÊâÄÊúâÈ´ò‰∫Æ');
        }

        function reapplyHighlights() {
            // ÈáçÊñ∞ÊáâÁî®ÊâÄÊúâÈ´ò‰∫Æ
            Object.entries(highlightColors).forEach(([text, colors]) => {
                colors.forEach(color => {
                    highlightWithColor(text, color);
                });
            });
        }

        // Â∑•ÂÖ∑ÂáΩÊï∏
        function scrollToTarget() {
            const targetLine = {{ result.target_line }};
            scrollToLine(targetLine);
        }

        function scrollToLine(lineNumber) {
            const lineElement = $(`#line-${lineNumber}`);
            if (lineElement.length > 0) {
                scrollToElement(lineElement);
            }
        }

        function scrollToElement(element) {
            const container = $('#line-container');
            const elementTop = element.position().top;
            const containerHeight = container.height();
            const scrollTo = container.scrollTop() + elementTop - (containerHeight / 2);
            
            container.animate({ scrollTop: scrollTo }, 300);
            
            // Ê∑ªÂä†È´ò‰∫ÆÊïàÊûú
            element.addClass('animate__animated animate__pulse');
            setTimeout(() => {
                element.removeClass('animate__animated animate__pulse');
            }, 1000);
        }

        function getCurrentLine() {
            const container = $('#line-container');
            const scrollTop = container.scrollTop();
            const containerHeight = container.height();
            const centerY = scrollTop + (containerHeight / 2);
            
            let closestLine = {{ result.target_line }};
            let minDistance = Infinity;
            
            $('.code-line').each(function() {
                const elementTop = $(this).position().top + scrollTop;
                const distance = Math.abs(elementTop - centerY);
                
                if (distance < minDistance) {
                    minDistance = distance;
                    closestLine = parseInt($(this).data('line'));
                }
            });
            
            return closestLine;
        }

        function updateCurrentLineStatus() {
            const currentLine = getCurrentLine();
            $('#status-line').text(`Á¨¨ ${currentLine} Ë°å`);
        }

        function jumpToLine() {
            const lineNumber = parseInt($('#jump-line').val());
            if (lineNumber && lineNumber >= 1 && lineNumber <= totalLines) {
                const url = new URL(window.location);
                url.searchParams.set('line', lineNumber);
                window.location.href = url.toString();
            } else {
                showToast('warning', `Ë´ãËº∏ÂÖ•ÊúâÊïàÁöÑË°åËôü (1-${totalLines})`);
            }
        }

        // ÁØÑÂúçÈÅ∏Êìá
        function showRangeSelector() {
            $('#range-selector').slideDown(300);
            $('#range-start').focus();
        }

        function closeRangeSelector() {
            $('#range-selector').slideUp(300);
        }

        function applyRange() {
            const start = parseInt($('#range-start').val());
            const end = parseInt($('#range-end').val());
            const context = parseInt($('#range-context').val()) || 200;
            
            if (start && end && start <= end && start >= 1 && end <= totalLines) {
                const url = new URL(window.location);
                url.searchParams.set('line', Math.floor((start + end) / 2));
                url.searchParams.set('start', start);
                url.searchParams.set('end', end);
                url.searchParams.set('context', context);
                window.location.href = url.toString();
            } else {
                showToast('warning', 'Ë´ãËº∏ÂÖ•ÊúâÊïàÁöÑÁØÑÂúç');
            }
        }

        // ÂåØÂá∫ÂäüËÉΩ
        function exportFile() {
            showToast('info', 'Ê≠£Âú®Ê∫ñÂÇô‰∏ãËºâÊ™îÊ°à...');
            
            // ‰ΩøÁî® window.open ‰∏ãËºâÊ™îÊ°à
            const downloadUrl = `/api/export_file?path=${encodeURIComponent('{{ file_path }}')}`;
            
            // ÂâµÂª∫‰∏ÄÂÄãÈö±ËóèÁöÑ iframe ‰æÜ‰∏ãËºâÊ™îÊ°à
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            iframe.src = downloadUrl;
            document.body.appendChild(iframe);
            
            // 5ÁßíÂæåÁßªÈô§ iframe
            setTimeout(() => {
                document.body.removeChild(iframe);
            }, 5000);
            
            showToast('success', 'Ê™îÊ°à‰∏ãËºâÂ∑≤ÈñãÂßã');
        }

        // Ë§áË£ΩÂäüËÉΩ
        function copySelectedText() {
            if (selectedText) {
                navigator.clipboard.writeText(selectedText).then(() => {
                    showToast('success', `Â∑≤Ë§áË£ΩÂà∞Ââ™Ë≤ºÁ∞ø: ${selectedText.substring(0, 20)}...`);
                }).catch(() => {
                    // Fallback
                    const textArea = document.createElement('textarea');
                    textArea.value = selectedText;
                    textArea.style.position = 'fixed';
                    textArea.style.left = '-9999px';
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showToast('success', `Â∑≤Ë§áË£ΩÂà∞Ââ™Ë≤ºÁ∞ø: ${selectedText.substring(0, 20)}...`);
                });
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showToast('success', `Â∑≤Ë§áË£ΩÂà∞Ââ™Ë≤ºÁ∞ø: ${text}`);
            }).catch(() => {
                // Fallback
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.left = '-9999px';
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showToast('success', `Â∑≤Ë§áË£ΩÂà∞Ââ™Ë≤ºÁ∞ø: ${text}`);
            });
        }

        function copyLineLink(lineNumber) {
            const url = new URL(window.location);
            url.searchParams.set('line', lineNumber);
            copyToClipboard(url.toString());
        }

        function openInNewPage(lineNumber) {
            const url = new URL(window.location);
            url.searchParams.set('line', lineNumber);
            window.open(url.toString(), '_blank');
        }

        // ÁãÄÊÖãÊõ¥Êñ∞
        function updateStatus() {
            updateCurrentLineStatus();
            updateBookmarkStatus();
            updateJumpStatus();
            $('#status-position').text(`${currentStartLine}-${currentEndLine} / ${totalLines}`);
        }

        function updateBookmarkStatus() {
            $('#status-bookmarks').text(`Êõ∏Á±§: ${bookmarks.size}`);
        }

        function updateJumpStatus() {
            $('#status-jumps').text(`Ë∑≥ËΩâÈªû: ${jumpPoints.size}`);
        }

        function updateSearchStatus(text) {
            $('#status-search').text(text);
        }

        // Toast ÊèêÁ§∫Á≥ªÁµ±
        function showToast(type, message) {
            const toastId = 'toast-' + Date.now();
            const iconMap = {
                'success': 'fa-check',
                'info': 'fa-info',
                'warning': 'fa-exclamation-triangle',
                'danger': 'fa-times'
            };
            
            const toast = $(`
                <div id="${toastId}" class="custom-toast ${type}">
                    <div class="toast-icon">
                        <i class="fas ${iconMap[type]}"></i>
                    </div>
                    <div class="toast-message">${message}</div>
                    <button class="toast-close" onclick="removeToast('${toastId}')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `);
            
            $('#toast-container').append(toast);
            
            // Ëá™ÂãïÁßªÈô§
            setTimeout(() => {
                removeToast(toastId);
            }, 3000);
        }

        function removeToast(toastId) {
            const toast = $('#' + toastId);
            toast.addClass('hiding');
            setTimeout(() => {
                toast.remove();
            }, 300);
        }

        // Áõ£ËÅΩÊªæÂãïÊõ¥Êñ∞ÁãÄÊÖã
        $('#line-container').on('scroll', debounce(updateStatus, 100));
    </script>
</body>
</html>