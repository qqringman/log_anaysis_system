<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¢å¼·æª”æ¡ˆæª¢è¦–å™¨ - {{ file_name }}</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Animate.css -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success-gradient: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            --danger-gradient: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            --warning-gradient: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            --line-highlight: rgba(255, 193, 7, 0.3);
            --line-target: rgba(220, 53, 69, 0.2);
            --search-highlight: rgba(255, 235, 59, 0.8);
            --bookmark-color: #28a745;
            --shadow-light: 0 4px 6px rgba(0,0,0,0.07);
            --shadow-medium: 0 8px 25px rgba(0,0,0,0.12);
            --shadow-heavy: 0 15px 35px rgba(0,0,0,0.1);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            font-size: 14px;
            margin: 0;
            padding-bottom: 60px;
            position: relative;
        }

        .file-header {
            background: var(--primary-gradient);
            color: white;
            padding: 1.5rem 0;
            box-shadow: var(--shadow-medium);
            position: relative;
            overflow: hidden;
        }

        .file-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
            opacity: 0.3;
        }

        .file-header .container-fluid {
            position: relative;
            z-index: 1;
        }

        .file-viewer {
            background: white;
            border-radius: 20px;
            box-shadow: var(--shadow-medium);
            overflow: hidden;
            margin-top: 1.5rem;
            position: relative;
        }

        .toolbar {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 1rem;
            border-bottom: 2px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.75rem;
        }

        .toolbar-group {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        .search-container {
            position: relative;
            max-width: 350px;
            min-width: 250px;
        }

        .search-input {
            padding-right: 3rem;
            border-radius: 25px;
            border: 2px solid #dee2e6;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }

        .search-info {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.8rem;
            color: #6c757d;
            background: white;
            padding: 2px 6px;
            border-radius: 12px;
            border: 1px solid #dee2e6;
        }

        .btn-modern {
            border-radius: 25px;
            padding: 8px 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .btn-modern:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-light);
        }

        .btn-gradient-primary {
            background: var(--primary-gradient);
            color: white;
            border-color: transparent;
        }

        .btn-gradient-primary:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            color: white;
        }

        .btn-gradient-success {
            background: var(--success-gradient);
            color: white;
        }

        .btn-gradient-warning {
            background: var(--warning-gradient);
            color: white;
        }

        .line-container {
            max-height: 75vh;
            overflow-y: auto;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
            background: #fafafa;
            position: relative;
            scroll-behavior: smooth;
        }

        .code-line {
            display: flex;
            border-bottom: 1px solid #eee;
            transition: all 0.2s ease;
            position: relative;
            min-height: 22px;
        }

        .code-line:hover {
            background: rgba(102, 126, 234, 0.05);
        }

        .line-number {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-right: 3px solid #dee2e6;
            padding: 6px 12px;
            text-align: right;
            min-width: 90px;
            color: #6c757d;
            font-weight: 600;
            user-select: none;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.3s ease;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: flex-end;
        }

        .line-number:hover {
            background: var(--primary-gradient);
            color: white;
            text-decoration: none;
            transform: scale(1.02);
        }

        .line-number.bookmark {
            background: var(--bookmark-color) !important;
            color: white !important;
            font-weight: bold;
            box-shadow: var(--shadow-light);
        }

        .line-number.bookmark::before {
            content: 'ğŸ“Œ';
            position: absolute;
            left: 4px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 10px;
        }

        .line-number.jump-point {
            background: var(--warning-gradient) !important;
            color: white !important;
            font-weight: bold;
        }

        .line-number.jump-point::after {
            content: 'ğŸ¯';
            position: absolute;
            left: 4px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 10px;
        }

        .line-content {
            flex: 1;
            padding: 6px 15px;
            background: white;
            white-space: pre-wrap;
            word-break: break-all;
            overflow-wrap: break-word;
            position: relative;
        }

        .line-target {
            background: var(--line-target) !important;
            border-left: 4px solid #dc3545;
            animation: targetPulse 2s ease-in-out;
        }

        .line-target .line-number {
            background: var(--danger-gradient);
            color: white;
            font-weight: bold;
        }

        .line-target .line-content {
            background: var(--line-target);
            font-weight: 500;
        }

        @keyframes targetPulse {
            0%, 100% { background: var(--line-target); }
            50% { background: rgba(220, 53, 69, 0.4); }
        }

        .search-highlight {
            background: var(--search-highlight) !important;
            color: #000 !important;
            border-radius: 3px;
            padding: 1px 3px;
            font-weight: bold;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            animation: highlightGlow 1s ease-in-out;
        }

        .search-highlight.current {
            background: #ff5722 !important;
            color: white !important;
            animation: currentHighlight 1s ease-in-out infinite alternate;
        }

        @keyframes highlightGlow {
            0% { box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
            50% { box-shadow: 0 0 10px rgba(255, 235, 59, 0.8); }
            100% { box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        }

        @keyframes currentHighlight {
            0% { transform: scale(1); }
            100% { transform: scale(1.1); }
        }

        /* å³éµé¸å–®highlighté¡è‰² */
        .highlight-color-1 { background: rgba(255, 235, 238, 0.9) !important; border-left: 3px solid #e91e63; }
        .highlight-color-2 { background: rgba(232, 245, 233, 0.9) !important; border-left: 3px solid #4caf50; }
        .highlight-color-3 { background: rgba(227, 242, 253, 0.9) !important; border-left: 3px solid #2196f3; }
        .highlight-color-4 { background: rgba(255, 243, 224, 0.9) !important; border-left: 3px solid #ff9800; }
        .highlight-color-5 { background: rgba(243, 229, 245, 0.9) !important; border-left: 3px solid #9c27b0; }
        .highlight-color-6 { background: rgba(255, 249, 196, 0.9) !important; border-left: 3px solid #ffeb3b; }
        .highlight-color-7 { background: rgba(224, 247, 250, 0.9) !important; border-left: 3px solid #00bcd4; }
        .highlight-color-8 { background: rgba(248, 231, 28, 0.9) !important; border-left: 3px solid #cddc39; }
        .highlight-color-9 { background: rgba(230, 238, 156, 0.9) !important; border-left: 3px solid #8bc34a; }
        .highlight-color-10 { background: rgba(255, 204, 188, 0.9) !important; border-left: 3px solid #ff5722; }

        .status-bar {
            background: linear-gradient(135deg, #343a40 0%, #495057 100%);
            color: white;
            padding: 0.75rem 1rem;
            font-size: 0.85rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            bottom: 0;
            z-index: 100;
        }

        .status-item {
            margin-right: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-item i {
            color: #ffc107;
        }

        .context-menu {
            position: fixed;
            background: white;
            border: none;
            border-radius: 12px;
            box-shadow: var(--shadow-heavy);
            padding: 0.5rem 0;
            z-index: 10000;
            min-width: 220px;
            backdrop-filter: blur(10px);
            animation: contextMenuSlide 0.2s ease-out;
        }

        @keyframes contextMenuSlide {
            0% { opacity: 0; transform: translateY(-10px) scale(0.95); }
            100% { opacity: 1; transform: translateY(0) scale(1); }
        }

        .context-menu-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 500;
        }

        .context-menu-item:hover {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            color: #667eea;
        }

        .context-menu-item.disabled {
            color: #6c757d;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .context-menu-separator {
            height: 1px;
            background: linear-gradient(90deg, transparent, #dee2e6, transparent);
            margin: 0.5rem 0;
        }

        .color-preview {
            width: 16px;
            height: 16px;
            border-radius: 3px;
            border: 1px solid #dee2e6;
        }

        .range-selector {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border: 2px solid #dee2e6;
            border-radius: 15px;
            padding: 1.5rem;
            margin: 1rem;
            box-shadow: var(--shadow-light);
            backdrop-filter: blur(10px);
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .compact-info {
            font-size: 0.85rem;
            color: rgba(255,255,255,0.9);
            margin-bottom: 0.5rem;
            background: rgba(255,255,255,0.1);
            padding: 0.5rem 1rem;
            border-radius: 25px;
            display: inline-block;
        }

        .jump-navigation {
            position: fixed;
            bottom: 80px;
            left: 20px;
            background: var(--warning-gradient);
            color: white;
            padding: 10px 15px;
            border-radius: 25px;
            box-shadow: var(--shadow-medium);
            font-size: 0.9rem;
            z-index: 999;
            display: none;
            animation: slideInLeft 0.3s ease-out;
        }

        @keyframes slideInLeft {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(0); }
        }

        .copyright-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            text-align: center;
            padding: 10px 0;
            font-size: 0.8rem;
            z-index: 100;
        }

        .copyright-footer i {
            color: #e74c3c;
            margin: 0 5px;
        }

        /* éŸ¿æ‡‰å¼èª¿æ•´ */
        @media (max-width: 768px) {
            .toolbar {
                flex-direction: column;
                align-items: stretch;
                gap: 1rem;
            }
            
            .toolbar-group {
                justify-content: center;
                flex-wrap: wrap;
            }
            
            .search-container {
                max-width: 100%;
                min-width: auto;
            }
            
            .line-number {
                min-width: 60px;
                font-size: 12px;
            }
            
            .file-header {
                padding: 1rem 0;
            }
            
            .file-header .display-6 {
                font-size: 1.5rem;
            }
        }

        /* æ»¾å‹•æ¢ç¾åŒ– */
        .line-container::-webkit-scrollbar {
            width: 12px;
        }

        .line-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 6px;
        }

        .line-container::-webkit-scrollbar-thumb {
            background: var(--primary-gradient);
            border-radius: 6px;
        }

        .line-container::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        }
    </style>
</head>
<body>
    <!-- æª”æ¡ˆæ¨™é¡Œå€åŸŸ -->
    <div class="file-header">
        <div class="container-fluid">
            <div class="row align-items-center">
                <div class="col-lg-8">
                    <h4 class="mb-2 animate__animated animate__fadeInLeft">
                        <i class="fas fa-file-code me-2"></i>{{ file_name }}
                    </h4>
                    <div class="compact-info animate__animated animate__fadeInLeft animate__delay-1s">
                        <i class="fas fa-info-circle me-1"></i>
                        {{ file_path }} | {{ result.total_lines }} è¡Œ | 
                        é¡¯ç¤º: {{ result.start_line }}-{{ result.end_line }} | 
                        ç›®æ¨™: {{ result.target_line }}
                    </div>
                </div>
                <div class="col-lg-4 text-end">
                    <div class="animate__animated animate__fadeInRight">
                        <button class="btn btn-outline-light btn-modern me-2" onclick="window.history.back()">
                            <i class="fas fa-arrow-left me-1"></i>è¿”å›
                        </button>
                        <button class="btn btn-gradient-success btn-modern" onclick="exportFile()">
                            <i class="fas fa-download me-1"></i>åŒ¯å‡ºæª”æ¡ˆ
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid">
        <!-- å·¥å…·åˆ— -->
        <div class="file-viewer">
            <div class="toolbar">
                <div class="toolbar-group">
                    <button class="btn btn-gradient-primary btn-modern" onclick="scrollToTarget()">
                        <i class="fas fa-crosshairs me-1"></i>ç›®æ¨™è¡Œ
                    </button>
                    <button class="btn btn-outline-info btn-modern" onclick="showRangeSelector()">
                        <i class="fas fa-edit me-1"></i>é¸æ“‡ç¯„åœ
                    </button>
                    <button class="btn btn-outline-warning btn-modern" onclick="clearAllHighlights()">
                        <i class="fas fa-eraser me-1"></i>æ¸…é™¤é«˜äº®
                    </button>
                    <button class="btn btn-outline-secondary btn-modern" onclick="toggleJumpMode()" id="jump-mode-btn">
                        <i class="fas fa-crosshairs me-1"></i>è·³è½‰æ¨¡å¼
                    </button>
                </div>
                
                <div class="toolbar-group">
                    <div class="search-container">
                        <input type="text" class="form-control search-input" 
                               id="search-input" placeholder="æœå°‹æ–‡å­— (Ctrl+F)">
                        <div class="search-info" id="search-info">0 / 0</div>
                    </div>
                    <button class="btn btn-outline-secondary btn-modern" onclick="findPrevious()" title="ä¸Šä¸€å€‹">
                        <i class="fas fa-chevron-up"></i>
                    </button>
                    <button class="btn btn-outline-secondary btn-modern" onclick="findNext()" title="ä¸‹ä¸€å€‹">
                        <i class="fas fa-chevron-down"></i>
                    </button>
                </div>
                
                <div class="toolbar-group">
                    <div class="input-group" style="width: 200px;">
                        <input type="number" class="form-control" id="jump-line" 
                               placeholder="è·³è½‰è¡Œè™Ÿ" min="1" max="{{ result.total_lines }}">
                        <button class="btn btn-gradient-primary" onclick="jumpToLine()">
                            <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- ç¯„åœé¸æ“‡å™¨ -->
            <div id="range-selector" class="range-selector" style="display: none;">
                <h6><i class="fas fa-edit me-2"></i>é¸æ“‡é¡¯ç¤ºç¯„åœ</h6>
                <div class="row">
                    <div class="col-md-3">
                        <label class="form-label">èµ·å§‹è¡Œ</label>
                        <input type="number" class="form-control" id="range-start" 
                               min="1" max="{{ result.total_lines }}" value="{{ result.start_line }}">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">çµæŸè¡Œ</label>
                        <input type="number" class="form-control" id="range-end" 
                               min="1" max="{{ result.total_lines }}" value="{{ result.end_line }}">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">ä¸Šä¸‹æ–‡è¡Œæ•¸</label>
                        <input type="number" class="form-control" id="range-context" 
                               min="0" max="500" value="200">
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button class="btn btn-gradient-primary me-2" onclick="applyRange()">
                            <i class="fas fa-check me-1"></i>å¥—ç”¨
                        </button>
                        <button class="btn btn-outline-secondary" onclick="closeRangeSelector()">
                            <i class="fas fa-times me-1"></i>å–æ¶ˆ
                        </button>
                    </div>
                </div>
            </div>

            <!-- ç¨‹å¼ç¢¼å…§å®¹ -->
            <div class="line-container" id="line-container">
                <div id="loading-overlay" class="loading-overlay" style="display: none;">
                    <div class="loading-spinner mb-3"></div>
                    <p>è¼‰å…¥æ›´å¤šå…§å®¹ä¸­...</p>
                </div>
                {% for line in result.lines %}
                <div class="code-line {% if line.is_target %}line-target{% endif %}" 
                     id="line-{{ line.line_number }}" data-line="{{ line.line_number }}">
                    <div class="line-number" 
                         onclick="handleLineClick({{ line.line_number }})"
                         oncontextmenu="showLineContextMenu(event, {{ line.line_number }})"
                         title="é»æ“Šè¨­å®šæ›¸ç±¤/è·³è½‰é»ï¼Œå³éµæ›´å¤šé¸é …">
                        {{ line.line_number }}
                    </div>
                    <div class="line-content" oncontextmenu="showContentContextMenu(event)">{{ line.content if line.content else ' ' }}</div>
                </div>
                {% endfor %}
            </div>

            <!-- ç‹€æ…‹åˆ— -->
            <div class="status-bar">
                <div class="d-flex align-items-center">
                    <div class="status-item">
                        <i class="fas fa-map-marker-alt"></i>
                        <span id="status-line">ç¬¬ {{ result.target_line }} è¡Œ</span>
                    </div>
                    <div class="status-item">
                        <i class="fas fa-bookmark"></i>
                        <span id="status-bookmarks">æ›¸ç±¤: 0</span>
                    </div>
                    <div class="status-item">
                        <i class="fas fa-search"></i>
                        <span id="status-search">æœå°‹: ç„¡</span>
                    </div>
                    <div class="status-item">
                        <i class="fas fa-crosshairs"></i>
                        <span id="status-jumps">è·³è½‰é»: 0</span>
                    </div>
                </div>
                <div class="d-flex align-items-center">
                    <div class="status-item">
                        <i class="fas fa-info-circle"></i>
                        <span id="status-position">{{ result.start_line }}-{{ result.end_line }} / {{ result.total_lines }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- è·³è½‰å°èˆª -->
    <div id="jump-navigation" class="jump-navigation">
        <i class="fas fa-crosshairs me-2"></i>
        è·³è½‰æ¨¡å¼å·²å•Ÿç”¨ - F2: ä¸‹ä¸€å€‹ | Shift+F2: ä¸Šä¸€å€‹
    </div>

    <!-- å³éµé¸å–® -->
    <div id="context-menu" class="context-menu" style="display: none;">
        <!-- å‹•æ…‹ç”Ÿæˆ -->
    </div>

    <!-- ç‰ˆæ¬Šè²æ˜ -->
    <div class="copyright-footer">
        <i class="fas fa-heart"></i>
        Â© 2025 Vince. All rights reserved.
        <i class="fas fa-code"></i>
        Enhanced File Viewer v5
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // å…¨åŸŸè®Šæ•¸
        let bookmarks = new Set();
        let jumpPoints = new Set();
        let currentJumpIndex = 0;
        let searchResults = [];
        let currentSearchIndex = 0;
        let highlightColors = {};
        let colorIndex = 1;
        let selectedText = '';
        let isLoadingMore = false;
        let jumpModeEnabled = false;
        let lastSearchText = '';
        
        // é é¢åˆå§‹åŒ–
        $(document).ready(function() {
            setupKeyboardShortcuts();
            setupScrollHandler();
            scrollToTarget();
            updateStatus();
            
            // åˆå§‹åŒ–å·¥å…·æç¤º
            initializeTooltips();
        });

        function initializeTooltips() {
            // ç‚ºå·¥å…·åˆ—æŒ‰éˆ•æ·»åŠ å·¥å…·æç¤º
            $('[title]').each(function() {
                $(this).attr('data-bs-toggle', 'tooltip');
            });
            
            // åˆå§‹åŒ– Bootstrap å·¥å…·æç¤º
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function(tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        }

        // éµç›¤å¿«æ·éµ
        function setupKeyboardShortcuts() {
            $(document).keydown(function(e) {
                // Ctrl+F æœå°‹
                if (e.ctrlKey && e.which === 70) {
                    e.preventDefault();
                    $('#search-input').focus().select();
                }
                
                // F2 è·³è½‰åŠŸèƒ½
                if (e.which === 113) { // F2
                    e.preventDefault();
                    if (e.shiftKey) {
                        gotoPreviousJump();
                    } else {
                        gotoNextJump();
                    }
                }
                
                // ESC æ¸…é™¤æœå°‹æˆ–é—œé–‰é¸å–®
                if (e.which === 27) {
                    if ($('#search-input').is(':focus')) {
                        clearSearch();
                    }
                    hideContextMenu();
                    if (jumpModeEnabled) {
                        toggleJumpMode();
                    }
                }
                
                // Ctrl+G è·³è½‰è¡Œè™Ÿ
                if (e.ctrlKey && e.which === 71) {
                    e.preventDefault();
                    $('#jump-line').focus().select();
                }
                
                // Enter åœ¨æœå°‹æ¡†ä¸­
                if (e.which === 13 && $('#search-input').is(':focus')) {
                    e.preventDefault();
                    if (e.shiftKey) {
                        findPrevious();
                    } else {
                        findNext();
                    }
                }
            });
            
            // æœå°‹è¼¸å…¥æ¡†äº‹ä»¶
            $('#search-input').on('input', debounce(performSearch, 300));
        }

        // é˜²æŠ–å‡½æ•¸
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // æ»¾å‹•è™•ç† - è‡ªå‹•è¼‰å…¥æ›´å¤šå…§å®¹
        function setupScrollHandler() {
            const container = $('#line-container');
            container.on('scroll', debounce(function() {
                if (isLoadingMore) return;
                
                const scrollTop = container.scrollTop();
                const scrollHeight = container[0].scrollHeight;
                const clientHeight = container.height();
                
                // æ¥è¿‘é ‚éƒ¨æ™‚è¼‰å…¥å‰é¢çš„å…§å®¹
                if (scrollTop < 100 && {{ result.start_line }} > 1) {
                    loadMoreContent('before');
                }
                
                // æ¥è¿‘åº•éƒ¨æ™‚è¼‰å…¥å¾Œé¢çš„å…§å®¹
                if (scrollTop + clientHeight > scrollHeight - 100 && {{ result.end_line }} < {{ result.total_lines }}) {
                    loadMoreContent('after');
                }
                
                // æ›´æ–°ç•¶å‰è¡Œç‹€æ…‹
                updateCurrentLineStatus();
            }, 100));
        }

        // è¼‰å…¥æ›´å¤šå…§å®¹
        function loadMoreContent(direction) {
            if (isLoadingMore) return;
            isLoadingMore = true;
            
            const loadingOverlay = $('#loading-overlay');
            loadingOverlay.show();
            
            const currentStart = {{ result.start_line }};
            const currentEnd = {{ result.end_line }};
            let newStart, newEnd;
            
            if (direction === 'before') {
                newStart = Math.max(1, currentStart - 200);
                newEnd = currentStart - 1;
            } else {
                newStart = currentEnd + 1;
                newEnd = Math.min({{ result.total_lines }}, currentEnd + 200);
            }
            
            $.get('/file_viewer', {
                path: '{{ file_path }}',
                line: direction === 'before' ? newStart : newEnd,
                context: 100,
                start: newStart,
                end: newEnd
            }).done(function(data) {
                // è§£æè¿”å›çš„HTMLä¸¦æå–æ–°è¡Œ
                const parser = new DOMParser();
                const doc = parser.parseFromString(data, 'text/html');
                const newLines = doc.querySelectorAll('.code-line');
                
                const container = $('#line-container');
                
                if (direction === 'before') {
                    // åœ¨å‰é¢æ’å…¥
                    const firstLine = container.find('.code-line').first();
                    newLines.forEach(line => {
                        const newElement = $(line.outerHTML);
                        firstLine.before(newElement);
                        
                        // é‡æ–°ç¶å®šäº‹ä»¶
                        bindLineEvents(newElement);
                    });
                } else {
                    // åœ¨å¾Œé¢æ·»åŠ 
                    newLines.forEach(line => {
                        const newElement = $(line.outerHTML);
                        container.append(newElement);
                        
                        // é‡æ–°ç¶å®šäº‹ä»¶
                        bindLineEvents(newElement);
                    });
                }
                
                updateStatus();
                
                // é‡æ–°æ‡‰ç”¨æœå°‹é«˜äº®
                if (lastSearchText) {
                    performSearch();
                }
                
            }).always(function() {
                loadingOverlay.hide();
                isLoadingMore = false;
            });
        }

        // ç¶å®šè¡Œäº‹ä»¶
        function bindLineEvents(lineElement) {
            const lineNumber = lineElement.data('line');
            
            lineElement.find('.line-number').on('click', function() {
                handleLineClick(lineNumber);
            }).on('contextmenu', function(e) {
                showLineContextMenu(e, lineNumber);
            });
            
            lineElement.find('.line-content').on('contextmenu', function(e) {
                showContentContextMenu(e);
            });
        }

        // è™•ç†è¡Œé»æ“Š
        function handleLineClick(lineNumber) {
            if (jumpModeEnabled) {
                toggleJumpPoint(lineNumber);
            } else {
                toggleBookmark(lineNumber);
            }
        }

        // è·³è½‰æ¨¡å¼åˆ‡æ›
        function toggleJumpMode() {
            jumpModeEnabled = !jumpModeEnabled;
            const btn = $('#jump-mode-btn');
            const navigation = $('#jump-navigation');
            
            if (jumpModeEnabled) {
                btn.removeClass('btn-outline-secondary').addClass('btn-gradient-warning');
                btn.html('<i class="fas fa-crosshairs me-1"></i>é€€å‡ºè·³è½‰');
                navigation.show();
                showAlert('è·³è½‰æ¨¡å¼å·²å•Ÿç”¨', 'info');
            } else {
                btn.removeClass('btn-gradient-warning').addClass('btn-outline-secondary');
                btn.html('<i class="fas fa-crosshairs me-1"></i>è·³è½‰æ¨¡å¼');
                navigation.hide();
                showAlert('è·³è½‰æ¨¡å¼å·²é—œé–‰', 'info');
            }
        }

        // åˆ‡æ›è·³è½‰é»
        function toggleJumpPoint(lineNumber) {
            const lineElement = $(`#line-${lineNumber} .line-number`);
            
            if (jumpPoints.has(lineNumber)) {
                jumpPoints.delete(lineNumber);
                lineElement.removeClass('jump-point');
            } else {
                jumpPoints.add(lineNumber);
                lineElement.addClass('jump-point');
            }
            
            updateJumpStatus();
        }

        // ä¸‹ä¸€å€‹è·³è½‰é»
        function gotoNextJump() {
            if (jumpPoints.size === 0) {
                showAlert('æ²’æœ‰è¨­å®šè·³è½‰é»ï¼Œè«‹å…ˆè¨­å®šè·³è½‰é»', 'warning');
                return;
            }
            
            const sortedJumps = Array.from(jumpPoints).sort((a, b) => a - b);
            const currentLine = getCurrentLine();
            
            let nextJump = sortedJumps.find(line => line > currentLine);
            if (!nextJump) {
                nextJump = sortedJumps[0]; // å¾ªç’°åˆ°ç¬¬ä¸€å€‹
            }
            
            scrollToLine(nextJump);
            updateJumpStatus();
            showAlert(`è·³è½‰åˆ°ç¬¬ ${nextJump} è¡Œ`, 'success');
        }

        // ä¸Šä¸€å€‹è·³è½‰é»
        function gotoPreviousJump() {
            if (jumpPoints.size === 0) {
                showAlert('æ²’æœ‰è¨­å®šè·³è½‰é»ï¼Œè«‹å…ˆè¨­å®šè·³è½‰é»', 'warning');
                return;
            }
            
            const sortedJumps = Array.from(jumpPoints).sort((a, b) => b - a);
            const currentLine = getCurrentLine();
            
            let prevJump = sortedJumps.find(line => line < currentLine);
            if (!prevJump) {
                prevJump = sortedJumps[0]; // å¾ªç’°åˆ°æœ€å¾Œä¸€å€‹
            }
            
            scrollToLine(prevJump);
            updateJumpStatus();
            showAlert(`è·³è½‰åˆ°ç¬¬ ${prevJump} è¡Œ`, 'success');
        }

        // æœå°‹åŠŸèƒ½
        function performSearch() {
            const searchText = $('#search-input').val().trim();
            lastSearchText = searchText;
            clearSearchHighlights();
            
            if (!searchText) {
                updateSearchStatus('æœå°‹: ç„¡');
                return;
            }
            
            searchResults = [];
            const regex = new RegExp(searchText.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
            
            $('.line-content').each(function(index) {
                const content = $(this).text();
                const matches = [...content.matchAll(regex)];
                
                if (matches.length > 0) {
                    const lineNumber = parseInt($(this).siblings('.line-number').text());
                    matches.forEach(match => {
                        searchResults.push({
                            line: lineNumber,
                            element: this,
                            index: match.index,
                            text: match[0]
                        });
                    });
                    
                    // é«˜äº®é¡¯ç¤º
                    const highlightedContent = content.replace(regex, '<span class="search-highlight">$&</span>');
                    $(this).html(highlightedContent);
                }
            });
            
            currentSearchIndex = 0;
            updateSearchStatus(`æ‰¾åˆ° ${searchResults.length} å€‹çµæœ`);
            
            if (searchResults.length > 0) {
                highlightCurrentResult();
            }
        }

        function clearSearchHighlights() {
            $('.search-highlight').each(function() {
                const parent = $(this).parent();
                const text = parent.text();
                parent.text(text);
            });
        }

        function highlightCurrentResult() {
            $('.search-highlight').removeClass('current');
            if (searchResults.length > 0 && currentSearchIndex < searchResults.length) {
                const result = searchResults[currentSearchIndex];
                
                // æ‰¾åˆ°å°æ‡‰çš„é«˜äº®å…ƒç´ 
                const lineElement = $(`#line-${result.line}`);
                const highlights = lineElement.find('.search-highlight');
                
                if (highlights.length > 0) {
                    highlights.eq(0).addClass('current');
                    scrollToElement(lineElement);
                }
                
                updateSearchStatus(`${currentSearchIndex + 1} / ${searchResults.length}`);
            }
        }

        function findNext() {
            if (searchResults.length === 0) return;
            currentSearchIndex = (currentSearchIndex + 1) % searchResults.length;
            highlightCurrentResult();
        }

        function findPrevious() {
            if (searchResults.length === 0) return;
            currentSearchIndex = currentSearchIndex > 0 ? currentSearchIndex - 1 : searchResults.length - 1;
            highlightCurrentResult();
        }

        function clearSearch() {
            $('#search-input').val('');
            clearSearchHighlights();
            searchResults = [];
            currentSearchIndex = 0;
            lastSearchText = '';
            updateSearchStatus('æœå°‹: ç„¡');
        }

        // æ›¸ç±¤åŠŸèƒ½
        function toggleBookmark(lineNumber) {
            const lineElement = $(`#line-${lineNumber} .line-number`);
            
            if (bookmarks.has(lineNumber)) {
                bookmarks.delete(lineNumber);
                lineElement.removeClass('bookmark');
                showAlert(`å·²ç§»é™¤ç¬¬ ${lineNumber} è¡Œçš„æ›¸ç±¤`, 'info');
            } else {
                bookmarks.add(lineNumber);
                lineElement.addClass('bookmark');
                showAlert(`å·²è¨­å®šç¬¬ ${lineNumber} è¡Œç‚ºæ›¸ç±¤`, 'success');
            }
            
            updateBookmarkStatus();
        }

        function gotoNextBookmark() {
            if (bookmarks.size === 0) {
                showAlert('æ²’æœ‰è¨­å®šæ›¸ç±¤', 'warning');
                return;
            }
            
            const sortedBookmarks = Array.from(bookmarks).sort((a, b) => a - b);
            const currentLine = getCurrentLine();
            
            let nextBookmark = sortedBookmarks.find(line => line > currentLine);
            if (!nextBookmark) {
                nextBookmark = sortedBookmarks[0]; // å¾ªç’°åˆ°ç¬¬ä¸€å€‹
            }
            
            scrollToLine(nextBookmark);
            updateStatus();
            showAlert(`è·³è½‰åˆ°æ›¸ç±¤ï¼šç¬¬ ${nextBookmark} è¡Œ`, 'success');
        }

        function gotoPreviousBookmark() {
            if (bookmarks.size === 0) {
                showAlert('æ²’æœ‰è¨­å®šæ›¸ç±¤', 'warning');
                return;
            }
            
            const sortedBookmarks = Array.from(bookmarks).sort((a, b) => b - a);
            const currentLine = getCurrentLine();
            
            let prevBookmark = sortedBookmarks.find(line => line < currentLine);
            if (!prevBookmark) {
                prevBookmark = sortedBookmarks[0]; // å¾ªç’°åˆ°æœ€å¾Œä¸€å€‹
            }
            
            scrollToLine(prevBookmark);
            updateStatus();
            showAlert(`è·³è½‰åˆ°æ›¸ç±¤ï¼šç¬¬ ${prevBookmark} è¡Œ`, 'success');
        }

        // å³éµé¸å–®
        function showLineContextMenu(event, lineNumber) {
            event.preventDefault();
            selectedText = '';
            showContextMenu(event, 'line', lineNumber);
        }

        function showContentContextMenu(event) {
            event.preventDefault();
            selectedText = window.getSelection().toString().trim();
            showContextMenu(event, 'content');
        }

        function showContextMenu(event, type, lineNumber = null) {
            const menu = $('#context-menu');
            let menuItems = [];
            
            if (type === 'line') {
                const isBookmarked = bookmarks.has(lineNumber);
                const isJumpPoint = jumpPoints.has(lineNumber);
                
                menuItems = [
                    { icon: 'bookmark', text: isBookmarked ? 'ç§»é™¤æ›¸ç±¤' : 'è¨­å®šæ›¸ç±¤', action: () => toggleBookmark(lineNumber) },
                    { icon: 'crosshairs', text: isJumpPoint ? 'ç§»é™¤è·³è½‰é»' : 'è¨­å®šè·³è½‰é»', action: () => toggleJumpPoint(lineNumber) },
                    { separator: true },
                    { icon: 'copy', text: 'è¤‡è£½è¡Œè™Ÿ', action: () => copyToClipboard(lineNumber.toString()) },
                    { icon: 'link', text: 'è¤‡è£½é€£çµ', action: () => copyLineLink(lineNumber) },
                    { icon: 'external-link-alt', text: 'åœ¨æ–°é é¢æ‰“é–‹', action: () => openInNewPage(lineNumber) }
                ];
            } else {
                menuItems = [
                    { icon: 'copy', text: 'è¤‡è£½', action: () => copySelectedText(), disabled: !selectedText },
                    { separator: true },
                    { icon: 'highlighter', text: 'æ™ºèƒ½é«˜äº®', action: () => highlightSelected(), disabled: !selectedText },
                    { separator: true }
                ];
                
                // æ·»åŠ é¡è‰²é¸é …
                const colors = [
                    { name: 'ç²‰ç´…', value: 1 },
                    { name: 'ç¶ è‰²', value: 2 },
                    { name: 'è—è‰²', value: 3 },
                    { name: 'æ©™è‰²', value: 4 },
                    { name: 'ç´«è‰²', value: 5 },
                    { name: 'é»ƒè‰²', value: 6 },
                    { name: 'é’è‰²', value: 7 },
                    { name: 'æª¸æª¬', value: 8 },
                    { name: 'è‰ç¶ ', value: 9 },
                    { name: 'ç´…æ©™', value: 10 }
                ];
                
                colors.forEach(color => {
                    menuItems.push({
                        icon: 'circle',
                        text: `${color.name}é«˜äº®`,
                        color: color.value,
                        action: () => highlightWithColor(selectedText, color.value),
                        disabled: !selectedText
                    });
                });
                
                menuItems.push({ separator: true });
                menuItems.push({ icon: 'eraser', text: 'æ¸…é™¤æ‰€æœ‰é«˜äº®', action: clearAllHighlights });
            }
            
            // ç”Ÿæˆé¸å–®HTML
            const menuHtml = menuItems.map(item => {
                if (item.separator) {
                    return '<div class="context-menu-separator"></div>';
                } else {
                    const disabledClass = item.disabled ? 'disabled' : '';
                    const colorPreview = item.color ? 
                        `<div class="color-preview highlight-color-${item.color}"></div>` : 
                        `<i class="fas fa-${item.icon}"></i>`;
                    
                    return `<div class="context-menu-item ${disabledClass}" data-action="${JSON.stringify(item).replace(/"/g, '&quot;')}">
                        ${colorPreview}
                        <span>${item.text}</span>
                    </div>`;
                }
            }).join('');
            
            menu.html(menuHtml);
            
            // ç¶å®šé»æ“Šäº‹ä»¶
            menu.find('.context-menu-item').on('click', function() {
                if ($(this).hasClass('disabled')) return;
                
                const actionData = JSON.parse($(this).attr('data-action'));
                if (actionData.action) {
                    actionData.action();
                }
                hideContextMenu();
            });
            
            // è¨ˆç®—ä½ç½®
            const menuWidth = 220;
            const menuHeight = menuItems.length * 40;
            const windowWidth = $(window).width();
            const windowHeight = $(window).height();
            
            let left = event.pageX;
            let top = event.pageY;
            
            if (left + menuWidth > windowWidth) {
                left = windowWidth - menuWidth - 10;
            }
            
            if (top + menuHeight > windowHeight) {
                top = windowHeight - menuHeight - 10;
            }
            
            menu.css({
                display: 'block',
                left: left + 'px',
                top: top + 'px'
            });
            
            // é»æ“Šå…¶ä»–åœ°æ–¹é—œé–‰é¸å–®
            $(document).one('click', hideContextMenu);
        }

        function hideContextMenu() {
            $('#context-menu').hide();
        }

        // é«˜äº®åŠŸèƒ½
        function highlightSelected() {
            if (!selectedText) return;
            highlightWithColor(selectedText, colorIndex);
            colorIndex = (colorIndex % 10) + 1;
        }

        function highlightWithColor(text, color) {
            if (!text) return;
            
            const escapedText = text.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const regex = new RegExp(escapedText, 'gi');
            
            $('.line-content').each(function() {
                const content = $(this).html();
                const highlightedContent = content.replace(regex, `<span class="highlight-color-${color}">$&</span>`);
                $(this).html(highlightedContent);
            });
            
            highlightColors[text] = color;
            showAlert(`å·²ç”¨é¡è‰² ${color} é«˜äº®æ–‡å­—: ${text}`, 'success');
        }

        function clearAllHighlights() {
            for (let i = 1; i <= 10; i++) {
                $(`.highlight-color-${i}`).each(function() {
                    const parent = $(this).parent();
                    const text = parent.text();
                    parent.text(text);
                });
            }
            highlightColors = {};
            showAlert('å·²æ¸…é™¤æ‰€æœ‰é«˜äº®', 'info');
        }

        // å·¥å…·å‡½æ•¸
        function scrollToTarget() {
            const targetLine = {{ result.target_line }};
            scrollToLine(targetLine);
        }

        function scrollToLine(lineNumber) {
            const lineElement = $(`#line-${lineNumber}`);
            if (lineElement.length > 0) {
                scrollToElement(lineElement);
            }
        }

        function scrollToElement(element) {
            const container = $('#line-container');
            const elementTop = element.position().top;
            const containerHeight = container.height();
            const scrollTo = container.scrollTop() + elementTop - (containerHeight / 2);
            
            container.animate({ scrollTop: scrollTo }, 300);
            
            // æ·»åŠ é«˜äº®æ•ˆæœ
            element.addClass('animate__animated animate__pulse');
            setTimeout(() => {
                element.removeClass('animate__animated animate__pulse');
            }, 1000);
        }

        function getCurrentLine() {
            const container = $('#line-container');
            const scrollTop = container.scrollTop();
            const containerHeight = container.height();
            const centerY = scrollTop + (containerHeight / 2);
            
            let closestLine = {{ result.target_line }};
            let minDistance = Infinity;
            
            $('.code-line').each(function() {
                const elementTop = $(this).position().top + scrollTop;
                const distance = Math.abs(elementTop - centerY);
                
                if (distance < minDistance) {
                    minDistance = distance;
                    closestLine = parseInt($(this).data('line'));
                }
            });
            
            return closestLine;
        }

        function updateCurrentLineStatus() {
            const currentLine = getCurrentLine();
            $('#status-line').text(`ç¬¬ ${currentLine} è¡Œ`);
        }

        function jumpToLine() {
            const lineNumber = parseInt($('#jump-line').val());
            if (lineNumber && lineNumber >= 1 && lineNumber <= {{ result.total_lines }}) {
                const url = new URL(window.location);
                url.searchParams.set('line', lineNumber);
                window.location.href = url.toString();
            } else {
                showAlert('è«‹è¼¸å…¥æœ‰æ•ˆçš„è¡Œè™Ÿ (1-{{ result.total_lines }})', 'warning');
            }
        }

        // ç¯„åœé¸æ“‡
        function showRangeSelector() {
            $('#range-selector').slideDown(300);
            $('#range-start').focus();
        }

        function closeRangeSelector() {
            $('#range-selector').slideUp(300);
        }

        function applyRange() {
            const start = parseInt($('#range-start').val());
            const end = parseInt($('#range-end').val());
            const context = parseInt($('#range-context').val()) || 200;
            
            if (start && end && start <= end && start >= 1 && end <= {{ result.total_lines }}) {
                const url = new URL(window.location);
                url.searchParams.set('line', Math.floor((start + end) / 2));
                url.searchParams.set('start', start);
                url.searchParams.set('end', end);
                url.searchParams.set('context', context);
                window.location.href = url.toString();
            } else {
                showAlert('è«‹è¼¸å…¥æœ‰æ•ˆçš„ç¯„åœ', 'warning');
            }
        }

        // åŒ¯å‡ºåŠŸèƒ½
        function exportFile() {
            const url = `/api/export_file?path=${encodeURIComponent('{{ file_path }}')}`;
            window.open(url, '_blank');
            showAlert('æ­£åœ¨æº–å‚™ä¸‹è¼‰æª”æ¡ˆ...', 'info');
        }

        // è¤‡è£½åŠŸèƒ½
        function copySelectedText() {
            if (selectedText) {
                navigator.clipboard.writeText(selectedText).then(() => {
                    showAlert(`å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿: ${selectedText.substring(0, 20)}...`, 'success');
                });
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showAlert(`å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿: ${text}`, 'success');
            });
        }

        function copyLineLink(lineNumber) {
            const url = new URL(window.location);
            url.searchParams.set('line', lineNumber);
            copyToClipboard(url.toString());
        }

        function openInNewPage(lineNumber) {
            const url = new URL(window.location);
            url.searchParams.set('line', lineNumber);
            window.open(url.toString(), '_blank');
        }

        // ç‹€æ…‹æ›´æ–°
        function updateStatus() {
            updateCurrentLineStatus();
            updateBookmarkStatus();
            updateJumpStatus();
        }

        function updateBookmarkStatus() {
            $('#status-bookmarks').text(`æ›¸ç±¤: ${bookmarks.size}`);
        }

        function updateJumpStatus() {
            $('#status-jumps').text(`è·³è½‰é»: ${jumpPoints.size}`);
        }

        function updateSearchStatus(text) {
            $('#status-search').text(text);
        }

        // æç¤ºè¨Šæ¯
        function showAlert(message, type) {
            // ç§»é™¤èˆŠçš„æç¤º
            $('.floating-alert').remove();
            
            const alertClass = {
                'success': 'alert-success',
                'info': 'alert-info',
                'warning': 'alert-warning',
                'danger': 'alert-danger'
            }[type] || 'alert-info';
            
            const alertHtml = `
                <div class="alert ${alertClass} floating-alert position-fixed animate__animated animate__fadeInDown" 
                     style="top: 20px; right: 20px; z-index: 9999; max-width: 300px; box-shadow: var(--shadow-medium);">
                    ${message}
                    <button type="button" class="btn-close" onclick="$(this).parent().remove()"></button>
                </div>
            `;
            
            $('body').append(alertHtml);
            
            setTimeout(() => {
                $('.floating-alert').addClass('animate__fadeOutUp');
                setTimeout(() => {
                    $('.floating-alert').remove();
                }, 500);
            }, 3000);
        }

        // ç›£è½æ»¾å‹•æ›´æ–°ç‹€æ…‹
        $('#line-container').on('scroll', debounce(updateStatus, 100));
    </script>
</body>
</html>