// Enhanced Log ÂàÜÊûêÂπ≥Âè∞ v6 - ‰ΩàÂ±ÄÁÆ°ÁêÜÂô®
// static/js/managers/layout-manager.js

window.layoutManager = {
    init: function() {
        console.log('üé® ÂàùÂßãÂåñ‰ΩàÂ±ÄÁÆ°ÁêÜÂô®');
        
        // ËºâÂÖ•ÂÑ≤Â≠òÁöÑ‰ΩàÂ±Ä
        this.loadSavedLayout();
        
        // ÂàùÂßãÂåñÊãñÂãïÂäüËÉΩ
        this.initDraggable();
        
        // Á∂ÅÂÆöÈçµÁõ§Âø´Êç∑Èçµ
        this.bindKeyboardShortcuts();
    },
    
    // ÂàùÂßãÂåñÊãñÂãïÂäüËÉΩ
    initDraggable: function() {
        console.log('üîß ÂàùÂßãÂåñÊãñÂãïÂäüËÉΩ');
        
        const currentLayout = appConfig.state.currentLayout;
        
        if (currentLayout === 'default') {
            // ÂïüÁî®ÊãñÂãïÂäüËÉΩ
            $('.dashboard-block').draggable({
                handle: '.drag-handle',
                revert: 'invalid',
                containment: 'parent',
                start: function(event, ui) {
                    $(this).addClass('ui-draggable-dragging');
                },
                stop: function(event, ui) {
                    $(this).removeClass('ui-draggable-dragging');
                    layoutManager.saveDashboardLayout();
                }
            });
            
            // ‰ΩøÂÆπÂô®ÂèØÊéíÂ∫è
            $('#dashboard-container').sortable({
                items: '.dashboard-block',
                handle: '.drag-handle',
                placeholder: 'ui-sortable-placeholder',
                tolerance: 'pointer',
                forcePlaceholderSize: true,
                revert: 300,
                update: function(event, ui) {
                    layoutManager.saveDashboardLayout();
                }
            });
            
            // ÂïüÁî® drop zone
            $('#dashboard-container').droppable({
                accept: '.dashboard-block',
                tolerance: 'pointer'
            });
        }
    },
    
    // Ë®≠ÁΩÆ‰ΩàÂ±Ä
    setLayout: function(layout) {
        console.log('üîÑ ÂàáÊèõ‰ΩàÂ±Ä:', layout);
        
        appConfig.state.currentLayout = layout;
        const container = $('#dashboard-container');
        
        // ÁßªÈô§ÊâÄÊúâ‰ΩàÂ±ÄÈ°ûÂà•
        container.removeClass('layout-default layout-grid layout-masonry');
        
        // Ê∑ªÂä†Êñ∞ÁöÑ‰ΩàÂ±ÄÈ°ûÂà•
        container.addClass(`layout-${layout}`);
        
        // Êõ¥Êñ∞ÊåâÈàïÁãÄÊÖã
        $('.layout-btn').removeClass('active');
        $(`.layout-btn[data-layout="${layout}"]`).addClass('active');
        
        // Êõ¥Êñ∞ÊªëÂãïËÉåÊôØ‰ΩçÁΩÆ
        this.updateLayoutSlider();
        
        // Ê†πÊìö‰ΩàÂ±ÄÈ°ûÂûãÈáçÊñ∞ÂàùÂßãÂåñÊãñÂãïÂäüËÉΩ
        if (layout === 'default') {
            // Èä∑ÊØÄÁèæÊúâÁöÑÊãñÂãïÂäüËÉΩ
            if ($('.dashboard-block').data('ui-draggable')) {
                $('.dashboard-block').draggable('destroy');
            }
            if (container.data('ui-sortable')) {
                container.sortable('destroy');
            }
            
            // ÈáçÊñ∞ÂàùÂßãÂåñÊãñÂãïÂäüËÉΩ
            setTimeout(() => {
                this.initDraggable();
            }, 100);
        } else {
            // ÂÖ∂‰ªñ‰ΩàÂ±ÄÁ¶ÅÁî®ÊãñÂãï
            if ($('.dashboard-block').data('ui-draggable')) {
                $('.dashboard-block').draggable('destroy');
            }
            if (container.data('ui-sortable')) {
                container.sortable('destroy');
            }
        }
        
        // ÂÑ≤Â≠ò‰ΩàÂ±ÄË®≠ÂÆö
        utils.saveLocal('currentLayout', layout);
        
        utils.showAlert(`üîÑ Â∑≤ÂàáÊèõÂà∞${layout === 'default' ? 'È†êË®≠' : layout === 'grid' ? 'Á∂≤Ê†º' : 'ÁÄëÂ∏ÉÊµÅ'}‰ΩàÂ±Ä`, 'info');
    },
    
    // Êõ¥Êñ∞‰ΩàÂ±ÄÊªëÂãïËÉåÊôØ
    updateLayoutSlider: function() {
        const activeBtn = $('.layout-btn.active');
        const slider = $('.layout-slider');
        
        if (activeBtn.length && slider.length) {
            const btnWidth = activeBtn.outerWidth();
            const btnLeft = activeBtn.position().left;
            
            slider.css({
                width: btnWidth + 'px',
                left: btnLeft + 'px'
            });
        }
    },
    
    // Ë®≠ÁΩÆË®≠ÂÇôË¶ñÂúñ
    setDeviceView: function(device) {
        if (device === 'mobile') {
            $('body').addClass('mobile-view');
            // Ë™øÊï¥Ë¶ñÂè£
            $('meta[name="viewport"]').attr('content', 'width=375, initial-scale=1.0');
            utils.showAlert('üì± Â∑≤ÂàáÊèõÂà∞ÊâãÊ©üË¶ñÂúñ', 'info');
        } else {
            $('body').removeClass('mobile-view');
            // ÊÅ¢Âæ©Ë¶ñÂè£
            $('meta[name="viewport"]').attr('content', 'width=device-width, initial-scale=1.0');
            utils.showAlert('üíª Â∑≤ÂàáÊèõÂà∞Ê°åÈù¢Ë¶ñÂúñ', 'info');
        }
        
        // ÂÑ≤Â≠òË®≠ÂÆö
        utils.saveLocal('deviceView', device);
    },
    
    // ÂÑ≤Â≠òÂÑÄË°®Êùø‰ΩàÂ±Ä
    saveDashboardLayout: function() {
        const layout = [];
        $('.dashboard-block').each(function(index) {
            const block = $(this);
            layout.push({
                id: block.attr('id'),
                order: index,
                position: {
                    top: block.css('top'),
                    left: block.css('left')
                }
            });
        });
        
        utils.saveLocal('dashboardLayout', layout);
        console.log('üíæ ‰ΩàÂ±ÄÂ∑≤ÂÑ≤Â≠ò');
    },
    
    // ËºâÂÖ•ÂÑ≤Â≠òÁöÑ‰ΩàÂ±Ä
    loadSavedLayout: function() {
        // ËºâÂÖ•‰ΩàÂ±ÄÈ°ûÂûã
        const savedLayout = utils.loadLocal('currentLayout', 'default');
        if (savedLayout !== 'default') {
            this.setLayout(savedLayout);
        }
        
        // ËºâÂÖ•ÊâãÊ©üË¶ñÂúñË®≠ÂÆö
        const mobileView = utils.loadLocal('mobileView', false);
        if (mobileView) {
            $('#mobile-view-toggle').prop('checked', true);
            this.toggleMobileView();
        }
        
        // ËºâÂÖ•ÂçÄÂ°äÈ†ÜÂ∫èÂíå‰ΩçÁΩÆ
        const dashboardLayout = utils.loadLocal('dashboardLayout');
        if (dashboardLayout && appConfig.state.currentLayout === 'default') {
            const container = $('#dashboard-container');
            
            // ÊåâÁÖßÂÑ≤Â≠òÁöÑÈ†ÜÂ∫èÈáçÊñ∞ÊéíÂàóÂçÄÂ°ä
            dashboardLayout.forEach(item => {
                const block = $(`#${item.id}`);
                if (block.length) {
                    container.append(block);
                    
                    // ÊÅ¢Âæ©‰ΩçÁΩÆÔºàÂ¶ÇÊûúÊúâÔºâ
                    if (item.position && item.position.top !== 'auto') {
                        block.css({
                            position: 'relative',
                            top: item.position.top,
                            left: item.position.left
                        });
                    }
                }
            });
        }
        
        console.log('üìÇ ‰ΩàÂ±ÄËºâÂÖ•ÂÆåÊàê');
    },
    
    // ÈáçÁΩÆ‰ΩàÂ±Ä
    resetLayout: function() {
        if (confirm('Á¢∫ÂÆöË¶ÅÈáçÁΩÆ‰ΩàÂ±ÄÂóéÔºüÈÄôÂ∞áÊ∏ÖÈô§ÊâÄÊúâËá™ÂÆöÁæ©Ë®≠ÂÆö„ÄÇ')) {
            // Ê∏ÖÈô§ÂÑ≤Â≠òÁöÑ‰ΩàÂ±Ä
            utils.clearLocal('dashboardLayout');
            utils.clearLocal('currentLayout');
            utils.clearLocal('mobileView');
            
            // ÈáçÊñ∞ËºâÂÖ•È†ÅÈù¢
            location.reload();
        }
    },
    
    // ÂåØÂá∫‰ΩàÂ±ÄÈÖçÁΩÆ
    exportLayout: function() {
        const config = {
            version: appConfig.version,
            layout: appConfig.state.currentLayout,
            mobileView: $('#mobile-view-toggle').is(':checked'),
            blocks: []
        };
        
        $('.dashboard-block').each(function() {
            const block = $(this);
            config.blocks.push({
                id: block.attr('id'),
                visible: block.is(':visible'),
                minimized: appConfig.state.minimizedBlocks.has(block.attr('id'))
            });
        });
        
        const json = JSON.stringify(config, null, 2);
        const blob = new Blob([json], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        
        const a = document.createElement('a');
        a.href = url;
        a.download = `layout_config_${new Date().getTime()}.json`;
        a.click();
        
        URL.revokeObjectURL(url);
        utils.showAlert('‚úÖ ‰ΩàÂ±ÄÈÖçÁΩÆÂ∑≤ÂåØÂá∫', 'success');
    },
    
    // ÂåØÂÖ•‰ΩàÂ±ÄÈÖçÁΩÆ
    importLayout: function() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        
        input.onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const config = JSON.parse(event.target.result);
                    
                    // È©óË≠âÈÖçÁΩÆ
                    if (!config.version || !config.layout) {
                        throw new Error('ÁÑ°ÊïàÁöÑÈÖçÁΩÆÊ™îÊ°à');
                    }
                    
                    // ÊáâÁî®ÈÖçÁΩÆ
                    this.setLayout(config.layout);
                    
                    if (config.mobileView) {
                        $('#mobile-view-toggle').prop('checked', true);
                        this.toggleMobileView();
                    }
                    
                    // ÊÅ¢Âæ©ÂçÄÂ°äÁãÄÊÖã
                    config.blocks.forEach(blockConfig => {
                        const block = $(`#${blockConfig.id}`);
                        if (block.length) {
                            if (blockConfig.minimized) {
                                blockManager.minimizeBlock(blockConfig.id, block.find('h4').text());
                            } else if (!blockConfig.visible) {
                                block.hide();
                            }
                        }
                    });
                    
                    utils.showAlert('‚úÖ ‰ΩàÂ±ÄÈÖçÁΩÆÂ∑≤ÂåØÂÖ•', 'success');
                    
                } catch (error) {
                    utils.showAlert('‚ùå ÂåØÂÖ•Â§±ÊïóÔºö' + error.message, 'danger');
                }
            };
            
            reader.readAsText(file);
        };
        
        input.click();
    },
    
    // ÂÖ®Ëû¢ÂπïÊ®°Âºè
    toggleFullscreen: function() {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen();
            utils.showAlert('üñ•Ô∏è ÈÄ≤ÂÖ•ÂÖ®Ëû¢ÂπïÊ®°Âºè', 'info');
        } else {
            if (document.exitFullscreen) {
                document.exitFullscreen();
                utils.showAlert('üñ•Ô∏è ÈÄÄÂá∫ÂÖ®Ëû¢ÂπïÊ®°Âºè', 'info');
            }
        }
    },
    
    // Á∂ÅÂÆöÈçµÁõ§Âø´Êç∑Èçµ
    bindKeyboardShortcuts: function() {
        $(document).on('keydown', function(e) {
            // F11 - ÂÖ®Ëû¢Âπï
            if (e.which === 122) {
                e.preventDefault();
                layoutManager.toggleFullscreen();
            }
            
            // Ctrl + L - ÂàáÊèõ‰ΩàÂ±Ä
            if (e.ctrlKey && e.which === 76) {
                e.preventDefault();
                const layouts = ['default', 'grid', 'masonry'];
                const currentIndex = layouts.indexOf(appConfig.state.currentLayout);
                const nextLayout = layouts[(currentIndex + 1) % layouts.length];
                layoutManager.setLayout(nextLayout);
            }
            
            // Ctrl + M - ÂàáÊèõÊâãÊ©üË¶ñÂúñ
            if (e.ctrlKey && e.which === 77) {
                e.preventDefault();
                $('#mobile-view-toggle').prop('checked', !$('#mobile-view-toggle').is(':checked'));
                layoutManager.toggleMobileView();
            }
        });
    }
};